<!DOCTYPE html>
<html lang="sw">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2E8B57">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizBook</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { background: #f5f5f5; color: #333; padding-bottom: 0px; }
        
        /* HEADER WITH SIDE MENU */
        header { 
            background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%); 
            color: white; 
            padding: 15px; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .menu-icon {
            font-size: 1.8rem;
            cursor: pointer;
            width: 40px;
            text-align: center;
        }
        .header-title {
            font-size: 1.4rem;
            font-weight: bold;
        }
        .header-spacer {
            width: 40px;
        }
        
        /* SIDE MENU */
        .side-menu {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 1000;
            padding: 20px 0;
            overflow-y: auto;
        }
        .side-menu.open {
            left: 0;
        }
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 999;
        }
        .menu-overlay.open {
            display: block;
        }
        .menu-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            color: #2E8B57;
            font-size: 1.2rem;
        }
        .menu-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }
        .menu-item:hover {
            background: #e8f5e9;
        }
        .menu-item span:first-child {
            font-size: 1.3rem;
            width: 30px;
        }
        
        /* TABS */
        .tabs { 
            display: flex; 
            background: white; 
            border-bottom: 2px solid #2E8B57; 
            overflow-x: auto;
            white-space: nowrap;
        }
        .tab-btn { 
            flex: 1; 
            padding: 12px 5px; 
            border: none; 
            background: white; 
            font-size: 0.8rem; 
            color: #555; 
            cursor: pointer; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 5px; 
            min-width: 70px;
        }
        .tab-btn.active { 
            background: #2E8B57; 
            color: white; 
            font-weight: bold; 
        }
        
        /* TAB CONTENT */
        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }
        
        /* CARDS */
        .card { 
            background: white; 
            border-radius: 10px; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
        }
        .card h3 { 
            color: #2E8B57; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #eee; 
        }
        
        /* ITEMS */
        .item { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            background: #f9f9f9; 
            border-radius: 5px; 
            border-left: 4px solid #2E8B57; 
            margin-bottom: 10px; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .item:hover { 
            background: #e8f5e9; 
            transform: translateY(-2px); 
        }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: bold; }
        .item-detail { font-size: 0.9rem; color: #666; }
        .item-amount { font-weight: bold; color: #2E8B57; }
        
        /* BUTTONS */
        .btn { 
            background: #2E8B57; 
            color: white; 
            border: none; 
            padding: 12px 20px; 
            border-radius: 5px; 
            font-size: 1rem; 
            cursor: pointer; 
            width: 100%; 
            margin-top: 10px; 
        }
        .btn-small {
            background: #2E8B57;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        /* STATS */
        .stats { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 15px; 
        }
        .stat { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            text-align: center; 
        }
        .stat-value { 
            font-size: 1.5rem; 
            font-weight: bold; 
            color: #2E8B57; 
        }
        
        /* BADGES */
        .badge { 
            display: inline-block; 
            padding: 2px 8px; 
            border-radius: 10px; 
            font-size: 0.8rem; 
            margin-left: 5px; 
        }
        .badge-danger { background: #e74c3c; color: white; }
        .badge-warning { background: #f39c12; color: white; }
        .badge-success { background: #2ecc71; color: white; }
        
        /* FORMS */
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
            margin-bottom: 10px; 
            font-size: 1rem;
        }
        
        /* HIDDEN/UTILITY */
        .hidden { display: none !important; }
        
        /* MARKETPLACE GRID */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .category-btn {
            padding: 10px;
            border: 1px solid #2E8B57;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .category-btn.active {
            background: #2E8B57;
            color: white;
        }
        
        /* TOUR GUIDE */
        .tour-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .tour-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 350px;
            text-align: center;
        }
        .tour-step {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .tour-title {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #2E8B57;
        }
        .tour-desc {
            margin-bottom: 20px;
            color: #666;
        }
        .tour-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
        }
        .tour-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
        }
        .tour-dot.active {
            background: #2E8B57;
        }
    </style>
    <script data-goatcounter="https://bizbook.goatcounter.com/count"
            async src="//gc.zgo.at/count.js"></script>
</head>
<body>
    <!-- SIDE MENU OVERLAY -->
    <div class="menu-overlay" id="menuOverlay" onclick="closeMenu()"></div>
    
    <!-- SIDE MENU -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">‚öôÔ∏è BIZBOOK MENU</div>
        
        <div class="menu-item" onclick="closeMenu(); showSettings()">
            <span>‚öôÔ∏è</span>
            <span>Settings</span>
        </div>
        
        <div class="menu-item" onclick="closeMenu(); openMarketplace()">
            <span>üõí</span>
            <span>Marketplace</span>
        </div>
        
        <div class="menu-item" onclick="closeMenu(); showHelp()">
            <span>üìñ</span>
            <span>Maagizo</span>
        </div>
        
        <div class="menu-item" onclick="closeMenu(); exportData()">
            <span>üì§</span>
            <span>Export Data</span>
        </div>
        
        <div class="menu-item" onclick="closeMenu(); importData()">
            <span>üì•</span>
            <span>Import Data</span>
        </div>
        
        <div class="menu-item" onclick="closeMenu(); showAbout()">
            <span>‚ÑπÔ∏è</span>
            <span>Kuhusu BizBook</span>
        </div>
        
        <div class="menu-item" onclick="closeMenu(); joinWhatsAppChannel()">
            <span>üì±</span>
            <span>WhatsApp Channel</span>
        </div>
        
        <div class="menu-item" onclick="closeMenu()">
            <span>‚ùå</span>
            <span>Funga</span>
        </div>
    </div>
    
    <!-- HEADER WITH MENU ICON -->
    <header>
        <div class="menu-icon" onclick="toggleMenu()">‚ò∞</div>
        <div class="header-title">üìì BizBook</div>
        <div class="header-spacer"></div>
    </header>
    
    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="bidhaa"><span>üì¶</span><span>Products</span></button>
        <button class="tab-btn" data-tab="mauzo"><span>üí∞</span><span>Sales</span></button>
        <button class="tab-btn" data-tab="fedha"><span>üè¶</span><span>Cash</span></button>
        <button class="tab-btn" data-tab="deni"><span>üìù</span><span>Debts</span></button>
        <button class="tab-btn" data-tab="nunua"><span>üöö</span><span>Buy</span></button>
    </div>

    <!-- PRODUCTS TAB -->
<div id="bidhaa" class="tab-content active">
    <div class="card">
        <h3>üì¶ Your Products</h3>
        <div class="item-list" id="stock-list"></div>
        <button class="btn" onclick="addProduct()">+ Add Product</button>
    </div>
</div>

<!-- SALES TAB -->
<div id="mauzo" class="tab-content">
    <div class="stats">
        <div class="stat"><div class="stat-value" id="today-sales">TZS 0</div><div class="stat-label">Today's Sales</div></div>
        <div class="stat"><div class="stat-value" id="sales-count">0</div><div class="stat-label">Customers</div></div>
    </div>
    <div class="card">
        <h3>üí∞ Today's Sales</h3>
        <div class="item-list" id="sales-list"></div>
    </div>
</div>

<!-- CASH TAB (Expense button moved here) -->
<div id="fedha" class="tab-content">
    <div class="card">
        <h3>üè¶ Cash Box</h3>
        <input type="number" id="morning-cash" placeholder="Morning Cash (TZS)">
        <div class="item">
            <div class="item-info"><div class="item-name">Today's Sales</div></div>
            <div class="item-amount" id="cash-sales-total">TZS 0</div>
        </div>
        <input type="number" id="expenses" placeholder="Today's Expenses (TZS)">
        <div class="item">
            <div class="item-info"><div class="item-name">Evening Cash</div></div>
            <div class="item-amount" id="expected-cash">TZS 0</div>
        </div>
        <button class="btn" onclick="saveCash()">üíæ Save Cash</button>
        
        <!-- EXPENSE BUTTON MOVED HERE (below Save Cash) -->
        <button class="btn" onclick="quickExpense()" style="margin-top: 10px; background: #f39c12;">üìù Add Expense</button>
    </div>
</div>

<!-- DEBTS TAB -->
<div id="deni" class="tab-content">
    <div class="card">
        <h3>üìù Money Owed</h3>
        <div class="item-list" id="debt-list"></div>
        <button class="btn" onclick="addDebtUSSD()">‚ûï Add Debt</button>
    </div>
</div>

<!-- BUY TAB -->
<div id="nunua" class="tab-content">
    <div class="card">
        <h3>üöö Need to Buy</h3>
        <div class="item-list" id="buy-list"></div>
        <div class="item">
            <div class="item-info"><div class="item-name">Approx Cost</div></div>
            <div class="item-amount" id="total-cost">TZS 0</div>
        </div>
        <button class="btn" onclick="createSmartOrder()">üì± Create Order</button>
    </div>
</div>

<!-- MARKETPLACE TAB (Hidden initially, shown via menu) -->
<div id="marketplace" class="tab-content">
    <div class="card">
        <h3>üõí Marketplace</h3>
        
        <!-- Search & Add -->
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="market-search" placeholder="Tafuta bidhaa au supplier..." style="flex: 1;">
            <button class="btn-small" onclick="searchMarketplace()">üîç</button>
        </div>
        
        <!-- Quick Actions -->
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <button class="btn-small" onclick="showRequestForm()" style="flex: 1;">üì¢ Weka Ombi</button>
            <button class="btn-small" onclick="showAddSupplierForm()" style="flex: 1;">‚ûï Add Supplier</button>
        </div>
        
        <!-- Tabs within Marketplace -->
        <div style="display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px;">
            <button class="category-btn active" onclick="switchMarketTab('suppliers')" id="tab-suppliers">Wauzaji Wangu</button>
            <button class="category-btn" onclick="switchMarketTab('public')" id="tab-public">Waliothibitishwa</button>
            <button class="category-btn" onclick="switchMarketTab('requests')" id="tab-requests">Maombi Yangu</button>
        </div>
        
        <!-- My Suppliers -->
        <div id="market-suppliers" class="market-section">
            <div id="supplier-list"></div>
            <button class="btn" onclick="shareMySuppliers()" style="margin-top: 10px;">üì§ Share Suppliers</button>
            <button class="btn" onclick="importSuppliers()" style="margin-top: 10px;">üì• Import Suppliers</button>
        </div>
        
        <!-- Public Suppliers -->
        <div id="market-public" class="market-section" style="display: none;">
            <div id="public-supplier-list"></div>
            <p style="color: #666; font-size: 0.8rem; text-align: center; margin-top: 10px;">
                ‚ö° Inahitaji internet kuona wauzaji waliothibitishwa
            </p>
        </div>
        
        <!-- My Requests -->
        <div id="market-requests" class="market-section" style="display: none;">
            <div id="requests-list"></div>
            <button class="btn" onclick="showRequestForm()" style="margin-top: 10px;">‚ûï Weka Ombi Jipya</button>
        </div>
    </div>
</div>

<!-- TOUR OVERLAY (Hidden by default) -->
<div id="tourOverlay" class="tour-overlay" style="display: none;">
    <div class="tour-card">
        <div class="tour-step" id="tourStep">1/4</div>
        <div class="tour-title" id="tourTitle">Add Product</div>
        <div class="tour-desc" id="tourDesc">Bonyeza "Add Product" kuweka bidhaa yako ya kwanza</div>
        <div class="tour-progress" id="tourProgress">
            <span class="tour-dot active"></span>
            <span class="tour-dot"></span>
            <span class="tour-dot"></span>
            <span class="tour-dot"></span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn-small" onclick="nextTourStep()" id="tourNext">Next ‚Üí</button>
            <button class="btn-small" onclick="endTour()" style="background: #999;">Skip</button>
        </div>
    </div>
</div>

    <script>
        // === CORE DATA ===
        function saveData(key, data) { 
            localStorage.setItem(key, JSON.stringify(data)); 
        }

        function loadData(key) { 
            const data = localStorage.getItem(key); 
            return data ? JSON.parse(data) : []; 
        }

        let stock = loadData('bizbook_stock') || [];
        let sales = loadData('bizbook_sales') || [];
        let debts = loadData('bizbook_debts') || [];
        let cash = loadData('bizbook_cash') || { morning: 0, expenses: 0 };
        let suppliers = loadData('bizbook_suppliers') || [];
        let requests = loadData('bizbook_requests') || [];
        
        // Public suppliers from GitHub (fetched later)
        let publicSuppliers = [];

        if (stock.length === 0) {
            // Empty stock - user will add their own products
            saveData('bizbook_stock', stock);
        }

        // === SIDE MENU FUNCTIONS ===
        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('open');
            document.getElementById('menuOverlay').classList.toggle('open');
        }

        function closeMenu() {
            document.getElementById('sideMenu').classList.remove('open');
            document.getElementById('menuOverlay').classList.remove('open');
        }

        // === TAB SYSTEM ===
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
                
                if (tabId === 'bidhaa') refreshStock();
                if (tabId === 'mauzo') refreshSales();
                if (tabId === 'fedha') refreshCash();
                if (tabId === 'deni') refreshDebts();
                if (tabId === 'nunua') refreshBuyList();
            });
        });

        // === 5-MINUTE TOUR (First-time users) ===
        let tourStep = 1;
        
        function startTour() {
            if (localStorage.getItem('tour_completed')) return;
            
            tourStep = 1;
            document.getElementById('tourOverlay').style.display = 'flex';
            updateTourStep();
        }

        function updateTourStep() {
            const steps = [
                { step: '1/4', title: 'Add Product', desc: 'Bonyeza "Add Product" kuweka bidhaa yako ya kwanza (mfano: Soda, Unga, Sukari)' },
                { step: '2/4', title: 'Make a Sale', desc: 'Bonyeza bidhaa yako kisha chagua "Make Sale" au tumia "Quick Sale"' },
                { step: '3/4', title: 'Add a Debt', desc: 'Nenda kwenye "Debts", weka jina na kiasi cha mteja aliyekopa' },
                { step: '4/4', title: 'Track Cash', desc: 'Nenda "Cash", weka pesa asubuhi na jioni kuona faida yako' }
            ];
            
            const s = steps[tourStep - 1];
            document.getElementById('tourStep').textContent = s.step;
            document.getElementById('tourTitle').textContent = s.title;
            document.getElementById('tourDesc').textContent = s.desc;
            
            // Update progress dots
            const dots = document.querySelectorAll('.tour-dot');
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i < tourStep);
            });
            
            document.getElementById('tourNext').textContent = tourStep === 4 ? 'Done ‚úÖ' : 'Next ‚Üí';
        }

        function nextTourStep() {
            if (tourStep < 4) {
                tourStep++;
                updateTourStep();
            } else {
                endTour();
            }
        }

        function endTour() {
            document.getElementById('tourOverlay').style.display = 'none';
            localStorage.setItem('tour_completed', 'true');
        }

        // === FIRST DAY ENGAGEMENT PUSH (After 1 hour) ===
setTimeout(() => {
    const hasUsed = localStorage.getItem('first_sale_made');
    if (!hasUsed && !localStorage.getItem('engagement_shown')) {
        if (confirm("üì¢ Bado hujafanya mauzo? Jaribu 'Quick Sale' sasa kuona jinsi BizBook inavyofanya kazi!")) {
            // Switch to Products tab
            document.querySelector('[data-tab="bidhaa"]').click();
        }
        localStorage.setItem('engagement_shown', 'true');
    }
}, 3600000); // 1 hour

        // === MARKETPLACE FUNCTIONS ===
        function openMarketplace() {
            // Show marketplace tab
            document.getElementById('marketplace').classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('marketplace').classList.add('active');
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            
            // Fetch public suppliers
            fetchPublicSuppliers();
            
            // Refresh marketplace views
            refreshSuppliersList();
            refreshRequestsList();
        }

        function switchMarketTab(tab) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            document.querySelectorAll('.market-section').forEach(section => section.style.display = 'none');
            document.getElementById(`market-${tab}`).style.display = 'block';
            
            if (tab === 'public') fetchPublicSuppliers();
            if (tab === 'suppliers') refreshSuppliersList();
            if (tab === 'requests') refreshRequestsList();
        }

        // === FETCH PUBLIC SUPPLIERS FROM GITHUB ===
        async function fetchPublicSuppliers() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/feistyfeller208-stack/bizbook-data/main/suppliers.json?t=' + Date.now());
                publicSuppliers = await response.json();
                displayPublicSuppliers();
            } catch (e) {
                publicSuppliers = [];
                document.getElementById('public-supplier-list').innerHTML = 
                    '<div style="color: #666; padding: 20px; text-align: center;">Hakuna internet. Jaribu tena baadaye.</div>';
            }
        }

        function displayPublicSuppliers() {
            const list = document.getElementById('public-supplier-list');
            
            if (publicSuppliers.length === 0) {
                list.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">Hakuna wauzaji waliothibitishwa kwa sasa</div>';
                return;
            }
            
            list.innerHTML = publicSuppliers.map(s => `
                <div class="item" onclick="contactSupplier('${s.name}', '${s.phone}')">
                    <div class="item-info">
                        <div class="item-name">${s.name} ‚úÖ</div>
                        <div class="item-detail">
                            ${s.category} | üìç ${s.location || 'N/A'}
                        </div>
                    </div>
                    <div class="item-amount">üìû</div>
                </div>
            `).join('');
        }

        function refreshSuppliersList() {
            const list = document.getElementById('supplier-list');
            
            if (suppliers.length === 0) {
                list.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">Hakuna wauzaji. Bonyeza "+ Add Supplier"</div>';
                return;
            }
            
            list.innerHTML = suppliers.map(s => `
                <div class="item" onclick="showSupplierMenu(${s.id})">
                    <div class="item-info">
                        <div class="item-name">${s.name}</div>
                        <div class="item-detail">
                            ${s.category || 'General'} | üìû ${s.phone}
                        </div>
                    </div>
                    <div class="item-amount">‚ãÆ</div>
                </div>
            `).join('');
        }

        function refreshRequestsList() {
            const list = document.getElementById('requests-list');
            
            if (requests.length === 0) {
                list.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">Hakuna maombi. Bonyeza "Weka Ombi"</div>';
                return;
            }
            
            list.innerHTML = requests.map(r => `
                <div class="item" onclick="showRequestMenu(${r.id})">
                    <div class="item-info">
                        <div class="item-name">${r.product}</div>
                        <div class="item-detail">
                            ${r.quantity} | üìç ${r.location} | ${r.status}
                        </div>
                    </div>
                    <div class="item-amount">${new Date(r.date).toLocaleDateString('sw-TZ')}</div>
                </div>
            `).join('');
        }

        function showAddSupplierForm() {
            const name = prompt("Jina la supplier:", "Bwana Juma");
            if (!name) return;
            
            const phone = prompt("Namba ya simu:", "2557xxxxxx");
            if (!phone) return;
            
            const category = prompt("Aina ya bidhaa (Drinks, Food, General):", "General");
            
            suppliers.push({
                id: Date.now(),
                name: name,
                phone: phone,
                category: category,
                date: new Date().toISOString()
            });
            
            saveData('bizbook_suppliers', suppliers);
            refreshSuppliersList();
            alert(`‚úÖ ${name} ameongezwa!`);
        }

        function showRequestForm() {
            const product = prompt("Unatafuta bidhaa gani?", "Soda");
            if (!product) return;
            
            const quantity = prompt("Kiasi gani?", "24");
            const location = prompt("Mahali gani?", "Kariakoo");
            
            const request = {
                id: Date.now(),
                product: product,
                quantity: quantity,
                location: location,
                status: "Open",
                date: new Date().toISOString()
            };
            
            requests.push(request);
            saveData('bizbook_requests', requests);
            
            // Ask if they want to contact suppliers
            if (confirm(`Ombi limehifadhiwa. Tuma kwa wauzaji wako sasa?`)) {
                contactSuppliersForRequest(request);
            }
            
            refreshRequestsList();
            switchMarketTab('requests');
        }

        function contactSuppliersForRequest(request) {
            const message = `Habari, natafuta ${request.product} ${request.quantity} mahali ${request.location}. Bei gani?`;
            
            if (suppliers.length === 0) {
                alert("Hakuna wauzaji wako. Ongeza wauzaji kwanza.");
                return;
            }
            
            suppliers.forEach(s => {
                if (confirm(`Tuma WhatsApp kwa ${s.name}?`)) {
                    window.open(`https://wa.me/${s.phone}?text=${encodeURIComponent(message)}`, '_blank');
                }
            });
        }

        function contactSupplier(name, phone) {
            const message = prompt(`Andika ujumbe kwa ${name}:`, "Habari, natafuta...");
            if (message) {
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
            }
        }

        function showSupplierMenu(supplierId) {
            const supplier = suppliers.find(s => s.id === supplierId);
            if (!supplier) return;
            
            const action = prompt(
                `${supplier.name}\nüìû ${supplier.phone}\n\n1. üí¨ WhatsApp\n2. üìû Call\n3. üì§ Share\n4. ‚ùå Delete`,
                "1"
            );
            
            switch(action) {
                case "1":
                    const msg = prompt("Ujumbe:", "Habari, natafuta...");
                    if (msg) window.open(`https://wa.me/${supplier.phone}?text=${encodeURIComponent(msg)}`, '_blank');
                    break;
                case "2":
                    window.open(`tel:${supplier.phone}`, '_blank');
                    break;
                case "3":
                    shareSupplier(supplier);
                    break;
                case "4":
                    if (confirm(`Delete ${supplier.name}?`)) {
                        suppliers = suppliers.filter(s => s.id !== supplierId);
                        saveData('bizbook_suppliers', suppliers);
                        refreshSuppliersList();
                    }
                    break;
            }
        }

        function shareSupplier(supplier) {
            const text = `BIZBOOK_SUPPLIER
${supplier.name}
${supplier.phone}
${supplier.category || 'General'}`;
            
            if (confirm("Share kwa WhatsApp?")) {
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            }
        }

        function shareMySuppliers() {
            if (suppliers.length === 0) {
                alert("Hakuna wauzaji wa kushare");
                return;
            }
            
            let text = "ORODHA YA WAUZAJI WANGU:\n\n";
            suppliers.forEach(s => {
                text += `‚Ä¢ ${s.name}: ${s.phone} (${s.category || 'General'})\n`;
            });
            
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function importSuppliers() {
            const pasted = prompt("Bandika orodha ya wauzaji uliopokea WhatsApp:");
            if (!pasted) return;
            
            const lines = pasted.split('\n');
            let count = 0;
            
            lines.forEach(line => {
                if (line.includes(':')) {
                    const parts = line.split(':');
                    const name = parts[0].replace('‚Ä¢', '').trim();
                    const phonePart = parts[1].trim().split(' ')[0];
                    
                    if (name && phonePart) {
                        suppliers.push({
                            id: Date.now() + count,
                            name: name,
                            phone: phonePart,
                            category: 'Imported',
                            date: new Date().toISOString()
                        });
                        count++;
                    }
                }
            });
            
            if (count > 0) {
                saveData('bizbook_suppliers', suppliers);
                refreshSuppliersList();
                alert(`‚úÖ Wauzaji ${count} wameongezwa!`);
            } else {
                alert("‚ùå Hakuna wauzaji waliopatikana. Hakikisha umebandika kwa usahihi.");
            }
        }

        function searchMarketplace() {
            const query = document.getElementById('market-search').value.toLowerCase();
            if (!query) return;
            
            const localMatches = suppliers.filter(s => 
                s.name.toLowerCase().includes(query) || 
                (s.category && s.category.toLowerCase().includes(query))
            );
            
            const publicMatches = publicSuppliers.filter(s => 
                s.name.toLowerCase().includes(query) || 
                s.category.toLowerCase().includes(query)
            );
            
            let result = "üîç MATOKEO YA UTAFUTAJI:\n\n";
            
            if (localMatches.length > 0) {
                result += "üì± WAUZAJI WAKO:\n";
                localMatches.forEach(s => result += `‚Ä¢ ${s.name} - ${s.phone}\n`);
            }
            
            if (publicMatches.length > 0) {
                result += "\nüåê WALIOTHIBITISHWA:\n";
                publicMatches.forEach(s => result += `‚Ä¢ ${s.name} ‚úÖ - ${s.phone}\n`);
            }
            
            if (localMatches.length === 0 && publicMatches.length === 0) {
                result += "Hakuna matokeo. Jaribu neno lingine.";
            }
            
            alert(result);
        }

        // === PRODUCT FUNCTIONS (Existing - Keep as is) ===
function addProduct() {
    const saleMethod = prompt(
        "How is this product SOLD?\n\n" +
        "1. By piece (individual items)\n" +
        "2. By weight (kilos, grams)\n" +
        "3. By volume (liters, milliliters)\n" +
        "4. From cartons/boxes\n" +
        "5. By length (meters, yards)\n" +
        "6. Other way\n\n" +
        "Enter number (1-6):",
        "1"
    );
    
    switch(saleMethod) {
        case "1": addPieceProduct(); break;
        case "2": addWeightProduct(); break;
        case "3": addVolumeProduct(); break;
        case "4": addCartonProduct(); break;
        case "5": addLengthProduct(); break;
        case "6": addCustomProduct(); break;
        default: addPieceProduct(); break;
    }
}

function addPieceProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const quantity = parseInt(prompt("Current quantity (pieces):", "100")) || 0;
    const price = parseInt(prompt("Selling price per piece (TZS):", "1000")) || 0;
    const cost = parseInt(prompt("Purchase cost per piece (TZS):", "700")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        unit: "pcs",
        minStock: Math.ceil(quantity * 0.3),
        orderQuantity: quantity
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${quantity} pieces\nSell: ${formatCurrency(price)}/piece`);
}

function addCartonProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const itemsPerCarton = parseInt(prompt("How many items in ONE carton/box?", "24")) || 24;
    const cartonCost = parseInt(prompt("Cost per CARTON (TZS):", "24000")) || 0;
    const itemPrice = parseInt(prompt("Selling price per ITEM (TZS):", "1500")) || 0;
    
    const costPerItem = cartonCost / itemsPerCarton;
    
    const cartonsInStock = parseInt(prompt("How many cartons do you have?", "10")) || 0;
    const totalItems = cartonsInStock * itemsPerCarton;
    
    const openItems = parseInt(prompt("How many items are already opened/sold individually?", "0")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: totalItems,
        price: itemPrice,
        cost: costPerItem,
        minStock: itemsPerCarton * 2,
        orderQuantity: itemsPerCarton,
        unit: "pcs",
        cartonSize: itemsPerCarton,
        cartonCost: cartonCost,
        wholeCartons: cartonsInStock - Math.ceil(openItems / itemsPerCarton),
        openItems: openItems % itemsPerCarton,
        itemType: "item"
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${cartonsInStock} cartons (${totalItems} items)\nBuy carton: ${formatCurrency(cartonCost)}\nSell per item: ${formatCurrency(itemPrice)}`);
}

function addWeightProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const unitType = prompt("Weight unit:\n1. Kilos (kg)\n2. Grams (g)\n3. Tonnes\n\nEnter number:", "1");
    const units = ['kg', 'g', 'tonne'];
    const unit = units[parseInt(unitType) - 1] || 'kg';
    
    const quantity = parseFloat(prompt(`Current quantity in ${unit}:`, unit === 'kg' ? "100" : "1000")) || 0;
    const price = parseInt(prompt(`Selling price per ${unit} (TZS):`, "2000")) || 0;
    const cost = parseInt(prompt(`Purchase cost per ${unit} (TZS):`, "1500")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        unit: unit,
        minStock: Math.ceil(quantity * 0.2),
        orderQuantity: quantity
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${quantity}${unit}\nSell: ${formatCurrency(price)}/${unit}`);
}

function addVolumeProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const unitType = prompt("Volume unit:\n1. Liters (L)\n2. Milliliters (ml)\n\nEnter number:", "1");
    const units = ['liter', 'ml'];
    const unit = units[parseInt(unitType) - 1] || 'liter';
    
    const quantity = parseFloat(prompt(`Current quantity in ${unit}:`, unit === 'liter' ? "20" : "1000")) || 0;
    const price = parseInt(prompt(`Selling price per ${unit} (TZS):`, "3000")) || 0;
    const cost = parseInt(prompt(`Purchase cost per ${unit} (TZS):`, "2000")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        unit: unit,
        minStock: Math.ceil(quantity * 0.2),
        orderQuantity: quantity
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${quantity}${unit}\nSell: ${formatCurrency(price)}/${unit}`);
}

function addLengthProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const unitType = prompt("Length unit:\n1. Meters (m)\n2. Yards (yd)\n\nEnter number:", "1");
    const units = ['meter', 'yard'];
    const unit = units[parseInt(unitType) - 1] || 'meter';
    
    const quantity = parseFloat(prompt(`Current quantity in ${unit}:`, unit === 'meter' ? "50" : "100")) || 0;
    const price = parseInt(prompt(`Selling price per ${unit} (TZS):`, "5000")) || 0;
    const cost = parseInt(prompt(`Purchase cost per ${unit} (TZS):`, "4000")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        unit: unit,
        minStock: Math.ceil(quantity * 0.2),
        orderQuantity: quantity
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${quantity}${unit}\nSell: ${formatCurrency(price)}/${unit}`);
}

function addCustomProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const customUnit = prompt("What unit do you use? (e.g., bunch, bundle, pair):", "bunch");
    const quantity = parseFloat(prompt(`Current quantity in ${customUnit}:`, "50")) || 0;
    const price = parseInt(prompt(`Selling price per ${customUnit} (TZS):`, "2000")) || 0;
    const cost = parseInt(prompt(`Purchase cost per ${customUnit} (TZS):`, "1500")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        unit: customUnit,
        minStock: Math.ceil(quantity * 0.3),
        orderQuantity: quantity
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${quantity} ${customUnit}\nSell: ${formatCurrency(price)}/${customUnit}`);
}

function refreshStock() {
    const stockList = document.getElementById('stock-list');
    
    if (stock.length === 0) {
        stockList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">No products. Click "Add Product" to start.</div>';
        return;
    }
    
    stockList.innerHTML = stock.map(item => {
        if (item.cartonSize) {
            const fullCartons = Math.floor((item.quantity - (item.openItems || 0)) / item.cartonSize);
            const itemType = item.itemType || "item";
            
            let badge = '';
            if (item.quantity === 0) {
                badge = '<span class="badge badge-danger">Empty!</span>';
            } else if (item.quantity <= item.minStock) {
                badge = '<span class="badge badge-warning">Reorder</span>';
            }
            
            return `
                <div class="item" onclick="showProductMenu(${item.id})">
                    <div class="item-info">
                        <div class="item-name">${item.name} üì¶ ${badge}</div>
                        <div class="item-detail">
                            ${item.quantity} ${itemType}s total<br>
                            ${fullCartons} full cartons + ${item.openItems || 0} open ${itemType}s<br>
                            Sell: ${formatCurrency(item.price)}/${itemType}
                        </div>
                    </div>
                    <div class="item-amount">
                        ${fullCartons}üì¶<br>
                        ${item.openItems || 0}üü¢
                    </div>
                </div>
            `;
        }
        
        let badge = '';
        if (item.quantity === 0) {
            badge = '<span class="badge badge-danger">Empty!</span>';
        } else if (item.quantity <= item.minStock * 0.5) {
            badge = '<span class="badge badge-danger">Low!</span>';
        } else if (item.quantity <= item.minStock) {
            badge = '<span class="badge badge-warning">Reorder</span>';
        }
        
        return `
            <div class="item" onclick="showProductMenu(${item.id})">
                <div class="item-info">
                    <div class="item-name">${item.name} ${badge}</div>
                    <div class="item-detail">
                        ${item.quantity}${item.unit || ''} | 
                        Sell: ${formatCurrency(item.price)}/${item.unit || 'unit'} |
                        Min: ${item.minStock || 0}${item.unit || ''}
                    </div>
                </div>
                <div class="item-amount">${item.quantity}</div>
            </div>
        `;
    }).join('');
}

function showProductMenu(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    const isCarton = product.cartonSize;
    
    const options = isCarton 
        ? `1. Make sale\n2. Change price\n3. Change quantity\n4. Set reorder logic\n5. View carton details\n6. Remove product`
        : `1. Make sale\n2. Change price\n3. Change quantity\n4. Set reorder logic\n5. Remove product`;
    
    const action = prompt(
        `${product.name}\nQuantity: ${product.quantity}${product.unit}\nPrice: ${formatCurrency(product.price)}/${product.unit}\nMin stock: ${product.minStock}${product.unit}\n\nChoose:\n${options}\n\nEnter number:`,
        "1"
    );
    
    if (isCarton) {
        switch(action) {
            case "1": makeCartonSale(productId); break;
            case "2": changeProductPrice(productId); break;
            case "3": changeProductQuantity(productId); break;
            case "4": setupSmartStock(productId); break;
            case "5": showCartonDetails(productId); break;
            case "6": deleteProduct(productId); break;
            default: break;
        }
    } else {
        switch(action) {
            case "1": makeSaleWithUnits(productId); break;
            case "2": changeProductPrice(productId); break;
            case "3": changeProductQuantity(productId); break;
            case "4": setupSmartStock(productId); break;
            case "5": deleteProduct(productId); break;
            default: break;
        }
    }
}

function makeCartonSale(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product || !product.cartonSize) return makeSaleWithUnits(productId);
    
    const customer = prompt("Customer name:", "Customer");
    const itemName = product.itemType || "item";
    
    const saleType = prompt(
        `Sell ${product.name} as:\n1. Single ${itemName}\n2. Whole carton (${product.cartonSize} ${itemName}s)\n3. Multiple ${itemName}s\n\nEnter choice:`,
        "1"
    );
    
    let quantity;
    let unit;
    
    switch(saleType) {
        case "1": quantity = 1; unit = itemName; break;
        case "2": quantity = product.cartonSize; unit = "carton"; break;
        case "3": quantity = parseInt(prompt(`How many ${itemName}s? (Available: ${product.quantity}):`, "2")) || 0; unit = itemName + "s"; break;
        default: return;
    }
    
    if (quantity > product.quantity) {
        alert(`Only ${product.quantity} ${itemName}s available!`);
        return;
    }
    
    const total = quantity * product.price;
    
    product.quantity -= quantity;
    
    if (product.cartonSize) {
        if (product.openItems >= quantity) {
            product.openItems -= quantity;
        } else {
            const remaining = quantity - product.openItems;
            product.openItems = product.cartonSize - (remaining % product.cartonSize);
            if (product.openItems === product.cartonSize) product.openItems = 0;
            product.wholeCartons = Math.floor((product.quantity - product.openItems) / product.cartonSize);
        }
    }
    
    const sale = {
        id: Date.now(),
        customer: customer,
        product: product.name,
        quantity: quantity,
        unit: unit,
        total: total,
        date: new Date().toISOString(),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };
    
    sales.push(sale);
    saveData('bizbook_sales', sales);
    saveData('bizbook_stock', stock);
    
    // Mark first sale
    if (!localStorage.getItem('first_sale_made')) {
        localStorage.setItem('first_sale_made', 'true');
    }
    
    refreshSales();
    refreshStock();
    updateCashCalculation();
    
    const message = saleType === "2" 
        ? `‚úÖ ${customer} bought 1 carton of ${product.name} (${quantity} ${itemName}s) = ${formatCurrency(total)}`
        : `‚úÖ ${customer} bought ${quantity} ${unit} of ${product.name} = ${formatCurrency(total)}`;
    
    alert(message);
}

function showCartonDetails(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product || !product.cartonSize) return;
    
    const fullCartons = Math.floor((product.quantity - (product.openItems || 0)) / product.cartonSize);
    
    alert(
        `üì¶ ${product.name} Carton Details:\n\n` +
        `‚Ä¢ Carton size: ${product.cartonSize} items\n` +
        `‚Ä¢ Cost per carton: ${formatCurrency(product.cartonCost)}\n` +
        `‚Ä¢ Cost per item: ${formatCurrency(product.cost)}\n` +
        `‚Ä¢ Sell per item: ${formatCurrency(product.price)}\n` +
        `‚Ä¢ Current stock: ${product.quantity} items\n` +
        `‚Ä¢ Full cartons: ${fullCartons}\n` +
        `‚Ä¢ Open items: ${product.openItems || 0}\n` +
        `‚Ä¢ Reorder at: ${product.minStock} items`
    );
}

function makeSaleWithUnits(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    const customer = prompt(`Customer buys ${product.name}. Customer name:`, "Customer");
    if (!customer) return;
    
    const quantity = parseFloat(prompt(
        `${product.name} (available: ${product.quantity}${product.unit})\nPrice: ${formatCurrency(product.price)}/${product.unit}\n\nQuantity in ${product.unit}:`,
        product.unit === 'pcs' ? "1" : product.unit === 'kg' ? "0.5" : "1"
    )) || 0;
    
    if (quantity > product.quantity) {
        alert(`Only ${product.quantity}${product.unit} of ${product.name} available!`);
        return;
    }
    
    const total = quantity * product.price;
    
    const newSale = {
        id: Date.now(),
        customer: customer,
        product: product.name,
        quantity: quantity,
        unit: product.unit,
        total: total,
        date: new Date().toISOString(),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };
    
    sales.push(newSale);
    saveData('bizbook_sales', sales);
    
    product.quantity -= quantity;
    saveData('bizbook_stock', stock);
    
    // Mark first sale
    if (!localStorage.getItem('first_sale_made')) {
        localStorage.setItem('first_sale_made', 'true');
    }
    
    refreshSales();
    refreshStock();
    refreshBuyList();
    updateCashCalculation();
    
    alert(`‚úÖ ${customer} bought ${product.name} √ó ${quantity}${product.unit} = ${formatCurrency(total)}`);
    }

            // === CASH FUNCTIONS ===
        function refreshCash() {
            const todaySales = sales.filter(sale => 
                new Date(sale.date).toDateString() === new Date().toDateString()
            );
            const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            
            document.getElementById('morning-cash').value = cash.morning || '';
            document.getElementById('expenses').value = cash.expenses || '';
            document.getElementById('cash-sales-total').textContent = formatCurrency(totalSales);
            
            updateCashCalculation();
        }

        function updateCashCalculation() {
            const morningCash = parseFloat(document.getElementById('morning-cash').value) || 0;
            const todaySales = sales.filter(sale => 
                new Date(sale.date).toDateString() === new Date().toDateString()
            );
            const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            const expenses = parseFloat(document.getElementById('expenses').value) || 0;
            
            const expectedCash = morningCash + totalSales - expenses;
            document.getElementById('expected-cash').textContent = formatCurrency(expectedCash);
        }

        function saveCash() {
            const morningCash = parseFloat(document.getElementById('morning-cash').value) || 0;
            const expenses = parseFloat(document.getElementById('expenses').value) || 0;
            
            cash = {
                morning: morningCash,
                expenses: expenses,
                lastUpdated: new Date().toISOString()
            };
            
            saveData('bizbook_cash', cash);
            alert('‚úÖ Cash saved!');
        }

        // === SALES FUNCTIONS ===
        function refreshSales() {
            const today = new Date().toDateString();
            const todaySales = sales.filter(sale => new Date(sale.date).toDateString() === today);
            const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            
            document.getElementById('today-sales').textContent = formatCurrency(totalSales);
            document.getElementById('sales-count').textContent = todaySales.length;
            document.getElementById('cash-sales-total').textContent = formatCurrency(totalSales);
            
            const salesList = document.getElementById('sales-list');
            if (todaySales.length === 0) {
                salesList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">No sales today</div>';
                return;
            }
            
            salesList.innerHTML = todaySales.map(sale => `
                <div class="item" onclick="showSaleMenu(${sale.id})">
                    <div class="item-info">
                        <div class="item-name">${sale.customer}</div>
                        <div class="item-detail">${sale.product} √ó ${sale.quantity}${sale.unit || ''} | ${sale.time}</div>
                    </div>
                    <div class="item-amount">${formatCurrency(sale.total)}</div>
                </div>
            `).join('');
        }

        // === DEBT FUNCTIONS (Fully updated) ===
        function refreshDebts() {
            const debtList = document.getElementById('debt-list');
            
            if (debts.length === 0) {
                debtList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">No debts</div>';
                return;
            }
            
            debts.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            debtList.innerHTML = debts.map(debt => `
                <div class="item" onclick="showDebtMenu(${debt.id})">
                    <div class="item-info">
                        <div class="item-name">${debt.customer}</div>
                        <div class="item-detail">
                            ${debt.date} ${debt.phone ? `| ${debt.phone}` : ''}
                            ${debt.note ? `<br><small>${debt.note}</small>` : ''}
                        </div>
                    </div>
                    <div class="item-amount">${formatCurrency(debt.amount)}</div>
                </div>
            `).join('');
        }

        function showDebtMenu(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;
            
            const options = `
1. üí¨ Send WhatsApp Reminder
2. ‚ûï Increase Debt Amount
3. ‚ûñ Decrease Debt Amount
4. ‚úÖ Mark as Paid (Remove)
5. üìù Add/Edit Note
6. ‚ùå Delete Debt
            `;
            
            const action = prompt(
                `${debt.customer}\nOwed: ${formatCurrency(debt.amount)}\nDate: ${debt.date}\n${debt.note ? `Note: ${debt.note}\n` : ''}\nChoose action:\n${options}`,
                "1"
            );
            
            switch(action) {
                case "1": sendDebtReminder(debtId); break;
                case "2": changeDebtAmount(debtId, 'increase'); break;
                case "3": changeDebtAmount(debtId, 'decrease'); break;
                case "4": markDebtAsPaid(debtId); break;
                case "5": addDebtNote(debtId); break;
                case "6": deleteDebt(debtId); break;
                default: break;
            }
        }

        function sendDebtReminder(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;
            
            if (!debt.phone) {
                const phone = prompt(`WhatsApp number for ${debt.customer}:`, "2557xxxxxx");
                if (!phone) return;
                debt.phone = phone;
                saveData('bizbook_debts', debts);
            }
            
            const message = `Habari ${debt.customer},\n\nKumbukumbu ya deni:\n\nKiasi: ${formatCurrency(debt.amount)}\nTarehe: ${debt.date}\n${debt.note ? `Sababu: ${debt.note}\n` : ''}\nTafadhali lipa deni lako.\n\nAsante.`;
            
            if (debt.phone) {
                window.open(`https://wa.me/${debt.phone}?text=${encodeURIComponent(message)}`, '_blank');
                alert(`‚úÖ WhatsApp message ready for ${debt.customer}`);
            } else {
                navigator.clipboard.writeText(message);
                alert(`‚úÖ Message copied!\n\nPaste in WhatsApp to ${debt.customer}`);
            }
        }

        function changeDebtAmount(debtId, action) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;
            
            const currentAmount = debt.amount;
            const changeType = action === 'increase' ? 'Increase' : 'Decrease';
            
            const changeAmount = parseInt(prompt(
                `${debt.customer}\nCurrent debt: ${formatCurrency(currentAmount)}\n\n${changeType} amount (TZS):`,
                "1000"
            )) || 0;
            
            if (changeAmount <= 0) return;
            
            if (action === 'increase') {
                debt.amount += changeAmount;
                debt.date = new Date().toLocaleDateString('sw-TZ');
                alert(`‚úÖ Debt increased by ${formatCurrency(changeAmount)}\nNew total: ${formatCurrency(debt.amount)}`);
            } else {
                if (changeAmount > debt.amount) {
                    alert(`‚ùå Cannot decrease by more than debt amount!`);
                    return;
                }
                debt.amount -= changeAmount;
                if (debt.amount === 0) {
                    markDebtAsPaid(debtId);
                    return;
                }
                alert(`‚úÖ Debt decreased by ${formatCurrency(changeAmount)}\nRemaining: ${formatCurrency(debt.amount)}`);
            }
            
            saveData('bizbook_debts', debts);
            refreshDebts();
        }

        function markDebtAsPaid(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;
            
            if (confirm(`‚úÖ Mark ${debt.customer}'s debt of ${formatCurrency(debt.amount)} as PAID?`)) {
                const sale = {
                    id: Date.now(),
                    customer: `${debt.customer} (Debt Paid)`,
                    product: "Debt Payment",
                    quantity: 1,
                    unit: "payment",
                    total: debt.amount,
                    date: new Date().toISOString(),
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                };
                
                sales.push(sale);
                saveData('bizbook_sales', sales);
                
                const index = debts.findIndex(d => d.id === debtId);
                if (index !== -1) {
                    debts.splice(index, 1);
                    saveData('bizbook_debts', debts);
                }
                
                refreshDebts();
                refreshSales();
                updateCashCalculation();
                
                alert(`‚úÖ ${debt.customer}'s debt marked as PAID\nAdded to today's sales`);
            }
        }

        function addDebtNote(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;
            
            const note = prompt(`Add note for ${debt.customer}'s debt:`, debt.note || "");
            
            if (note !== null) {
                debt.note = note;
                saveData('bizbook_debts', debts);
                refreshDebts();
                alert(`‚úÖ Note added for ${debt.customer}`);
            }
        }

        function deleteDebt(debtId) {
            const debt = debts.find(d => d.id === debtId);
            if (!debt) return;
            
            if (confirm(`‚ùå Permanently delete ${debt.customer}'s debt of ${formatCurrency(debt.amount)}?`)) {
                const index = debts.findIndex(d => d.id === debtId);
                if (index !== -1) {
                    debts.splice(index, 1);
                    saveData('bizbook_debts', debts);
                    refreshDebts();
                    alert(`‚úÖ ${debt.customer}'s debt deleted`);
                }
            }
        }

        function addDebtUSSD() {
            const customer = prompt("Customer name:", "Customer");
            if (!customer) return;
            
            const amount = parseInt(prompt(`Debt amount (TZS):`, "5000")) || 0;
            const phone = prompt("Customer phone (optional):", "") || "";
            const note = prompt("Reason/Note (optional):", "") || "";
            
            if (!customer || amount <= 0) {
                alert("Enter customer name and debt amount");
                return;
            }
            
            const newDebt = {
                id: Date.now(),
                customer: customer,
                amount: amount,
                phone: phone,
                note: note,
                date: new Date().toLocaleDateString('sw-TZ')
            };
            
            debts.push(newDebt);
            saveData('bizbook_debts', debts);
            refreshDebts();
            
            if (phone && confirm(`Send WhatsApp reminder to ${customer}?`)) {
                const message = `Habari ${customer},\n\nUmekopa: ${formatCurrency(amount)}\nTarehe: ${newDebt.date}\n${note ? `Sababu: ${note}\n` : ''}\nTafadhali kumbuka kulipa.`;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
            }
            
            alert(`‚úÖ ${formatCurrency(amount)} debt added for ${customer}`);
        }

        // === EXPORT FUNCTIONS ===
        function exportData() {
            const exportType = prompt(
                "üì§ Export as:\n\n" +
                "1. üìÑ SIMPLE RECEIPT (for today only)\n" +
                "2. üìã DAILY REPORT (sales + cash summary)\n" +
                "3. üìä STOCK REPORT (what to buy)\n" +
                "4. üìà BUSINESS REPORT (all data)\n\n" +
                "Enter number (1-4):",
                "1"
            );
            
            switch(exportType) {
                case "1": exportSimpleReceipt(); break;
                case "2": exportDailyReport(); break;
                case "3": exportStockReport(); break;
                case "4": exportBusinessReport(); break;
                default: exportSimpleReceipt(); break;
            }
        }

        function exportSimpleReceipt() {
            const today = new Date().toLocaleDateString('sw-TZ');
            const todaySales = sales.filter(sale => 
                new Date(sale.date).toDateString() === new Date().toDateString()
            );
            
            let receipt = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n`;
            receipt += `‚ïë      üìì BIZBOOK RECEIPT       ‚ïë\n`;
            receipt += `‚ïë      ${today}       ‚ïë\n`;
            receipt += `‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n`;
            
            if (todaySales.length === 0) {
                receipt += `‚ïë   Hakuna mauzo leo           ‚ïë\n`;
            } else {
                let total = 0;
                todaySales.forEach(sale => {
                    receipt += `‚ïë ${sale.product} √ó ${sale.quantity}${sale.unit}\n`;
                    receipt += `‚ïë   ${sale.customer}: ${formatCurrency(sale.total)}\n`;
                    total += sale.total;
                });
                receipt += `‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n`;
                receipt += `‚ïë JUMLA: ${formatCurrency(total).padStart(20)} ‚ïë\n`;
            }
            
            receipt += `‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n`;
            
            navigator.clipboard.writeText(receipt);
            alert(`‚úÖ Receipt copied!\n\n${receipt}`);
        }

        function exportDailyReport() {
            const today = new Date().toLocaleDateString('sw-TZ');
            const todaySales = sales.filter(sale => 
                new Date(sale.date).toDateString() === new Date().toDateString()
            );
            const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
            
            let report = `=== BIZBOOK DAILY REPORT ===\n`;
            report += `Date: ${today}\n`;
            report += `‚ïê`.repeat(35) + `\n\n`;
            report += `üì¶ MORNING CASH: ${formatCurrency(cash.morning || 0)}\n`;
            report += `üí∞ TODAY'S SALES:\n`;
            report += `‚îÄ`.repeat(35) + `\n`;
            
            todaySales.forEach(sale => {
                report += `‚Ä¢ ${sale.time} - ${sale.customer}: ${formatCurrency(sale.total)}\n`;
            });
            
            report += `‚ïê`.repeat(35) + `\n`;
            report += `TOTAL SALES: ${formatCurrency(totalSales)}\n`;
            report += `EXPENSES: ${formatCurrency(cash.expenses || 0)}\n`;
            report += `EXPECTED CASH: ${formatCurrency((cash.morning || 0) + totalSales - (cash.expenses || 0))}\n`;
            
            navigator.clipboard.writeText(report);
            alert(`‚úÖ Daily report copied!\n\n${report}`);
        }

        function exportStockReport() {
            let report = `=== BIZBOOK STOCK REPORT ===\n`;
            report += `Date: ${new Date().toLocaleDateString('sw-TZ')}\n`;
            report += `‚ïê`.repeat(35) + `\n\n`;
            
            stock.forEach(item => {
                const status = item.quantity <= item.minStock ? "‚ö†Ô∏è LOW" : "‚úÖ OK";
                report += `${status} ${item.name}: ${item.quantity}${item.unit}\n`;
            });
            
            navigator.clipboard.writeText(report);
            alert(`‚úÖ Stock report copied!\n\n${report}`);
        }

        function exportBusinessReport() {
            const allData = {
                stock: stock,
                sales: sales,
                debts: debts,
                cash: cash,
                suppliers: suppliers,
                requests: requests,
                exported: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `bizbook-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Business report saved as JSON`);
        }

        function importData() {
            if (!confirm("‚ö†Ô∏è Hii itabadilisha data yako ya sasa. Weka backup kwanza?")) return;
            
            const pasted = prompt("Bandika data ya BizBook uliyohifadhi (JSON):");
            if (!pasted) return;
            
            try {
                const imported = JSON.parse(pasted);
                if (imported.stock) stock = imported.stock;
                if (imported.sales) sales = imported.sales;
                if (imported.debts) debts = imported.debts;
                if (imported.cash) cash = imported.cash;
                if (imported.suppliers) suppliers = imported.suppliers;
                if (imported.requests) requests = imported.requests;
                
                saveData('bizbook_stock', stock);
                saveData('bizbook_sales', sales);
                saveData('bizbook_debts', debts);
                saveData('bizbook_cash', cash);
                saveData('bizbook_suppliers', suppliers);
                saveData('bizbook_requests', requests);
                
                alert("‚úÖ Data imeingizwa!");
                location.reload();
            } catch (e) {
                alert("‚ùå Data si sahihi. Hakikisha umebandika JSON halisi.");
            }
        }

        // === UTILITY FUNCTIONS ===
        function formatCurrency(amount) {
            return new Intl.NumberFormat('sw-TZ', {
                style: 'currency',
                currency: 'TZS',
                minimumFractionDigits: 0
            }).format(amount);
        }

        function showHelp() {
            alert(`‚ùì MASWALI YA MARA KWA MARA:

üì± JINSI YA KUIPAKUA BIZBOOK:
1. Fungua Chrome
2. Nenda: https://feistyfeller208-stack.github.io/BizBook/
3. Bonyeza "‚ãÆ" (dots tatu) ‚Üí "Add to Home Screen"

üõí MARKETPLACE:
‚Ä¢ Ongeza wauzaji wako kwenye "Marketplace"
‚Ä¢ Tuma maombi ya bidhaa moja kwa moja
‚Ä¢ Wauzaji wanaweza kusharewa WhatsApp

üí∞ DENI NA PESA:
‚Ä¢ Deni: Andika, bonyeza jina, tuma WhatsApp
‚Ä¢ Pesa: Weka asubuhi na jioni

üìû Support: +255759968552`);
        }

        function showAbout() {
            alert(`üíº BIZBOOK v4.0

App ya kuendesha biashara yako
‚Ä¢ Marketplace ya wauzaji
‚Ä¢ Offline kabisa
‚Ä¢ Inahifadhi kwenye simu

üë®‚Äçüíª Developed by: Guy Fei
üìû Support: +255759968552`);
        }

        function showSettings() {
            alert(`‚öôÔ∏è SETTINGS

‚Ä¢ Marketplace: Ongeza/ondoa wauzaji
‚Ä¢ Export/Import: Hifadhi data yako
‚Ä¢ Channel: Jiunge na WhatsApp channel

Zipo kwenye menu ya kando!`);
        }

        function joinWhatsAppChannel() {
    const channelLink = "https://whatsapp.com/channel/0029VbC5Bc3BadmfhZogbs3q";
    window.open(channelLink, '_blank');
        }

        // === BUY TAB FUNCTIONS (Keep existing) ===
        function refreshBuyList() {
            const buyList = document.getElementById('buy-list');
            let itemsToBuy = [];
            let totalCost = 0;
            
            stock.forEach(item => {
                if (item.quantity <= item.minStock) {
                    const needed = item.orderQuantity || (item.minStock * 3 - item.quantity);
                    const cost = needed * item.cost;
                    
                    itemsToBuy.push({
                        id: item.id,
                        name: item.name,
                        needed: needed,
                        unit: item.unit,
                        current: item.quantity,
                        minStock: item.minStock,
                        cost: cost
                    });
                    
                    totalCost += cost;
                }
            });
            
            document.getElementById('total-cost').textContent = formatCurrency(totalCost);
            
            if (itemsToBuy.length === 0) {
                buyList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">Nothing to buy now</div>';
                return;
            }
            
            buyList.innerHTML = itemsToBuy.map(item => `
                <div class="item" onclick="showBuyOptions('${item.name}')">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-detail">
                            Now: ${item.current}${item.unit} | Need: ${item.needed}${item.unit}
                        </div>
                    </div>
                    <div class="item-amount">${formatCurrency(item.cost)}</div>
                </div>
            `).join('');
        }

        function showBuyOptions(productName) {
            const product = stock.find(p => p.name === productName);
            if (!product) return;
            
            const action = prompt(
                `${product.name}\nNeed: ${product.orderQuantity || (product.minStock * 3 - product.quantity)}${product.unit}\nCost: ${formatCurrency((product.orderQuantity || (product.minStock * 3 - product.quantity)) * product.cost)}\n\n1. Order from suppliers\n2. Mark as bought`,
                "1"
            );
            
            if (action === "1") {
                // Go to marketplace with this product
                openMarketplace();
                switchMarketTab('suppliers');
                
                setTimeout(() => {
                    document.getElementById('market-search').value = product.name;
                    searchMarketplace();
                }, 500);
            } else if (action === "2") {
                const needed = product.orderQuantity || (product.minStock * 3 - product.quantity);
                product.quantity += needed;
                saveData('bizbook_stock', stock);
                refreshStock();
                refreshBuyList();
                alert(`‚úÖ ${needed}${product.unit} added to stock`);
            }
        }

        function createSmartOrder() {
            let itemsToBuy = [];
            let totalCost = 0;
            let supplierMessage = "";
            
            stock.forEach(item => {
                if (item.quantity <= item.minStock) {
                    const needed = item.orderQuantity || (item.minStock * 3 - item.quantity);
                    const cost = needed * item.cost;
                    itemsToBuy.push({ name: item.name, needed: needed, unit: item.unit });
                    totalCost += cost;
                    supplierMessage += `‚Ä¢ ${item.name}: ${needed}${item.unit}\n`;
                }
            });
            
            if (itemsToBuy.length === 0) {
                alert('Nothing to buy now');
                return;
            }
            
            if (suppliers.length > 0) {
                if (confirm(`Tuma order kwa wauzaji wako (${suppliers.length})?`)) {
                    const message = `Ninaomba:\n${supplierMessage}\nJumla: ${formatCurrency(totalCost)}`;
                    
                    suppliers.forEach(s => {
                        if (confirm(`Tuma kwa ${s.name}?`)) {
                            window.open(`https://wa.me/${s.phone}?text=${encodeURIComponent(message)}`, '_blank');
                        }
                    });
                }
            } else {
                alert("Hakuna wauzaji. Waongeze kwenye Marketplace kwanza.");
            }
        }

        function quickExpense() {
            const amount = parseFloat(prompt('Expense amount (TZS):', '')) || 0;
            const reason = prompt('Reason:', '') || 'Expense';
            
            if (amount <= 0) {
                alert('Enter amount');
                return;
            }
            
            const currentExpenses = cash.expenses || 0;
            cash.expenses = currentExpenses + amount;
            saveData('bizbook_cash', cash);
            
            document.getElementById('expenses').value = cash.expenses;
            updateCashCalculation();
            
            alert(`‚úÖ ${reason}: ${formatCurrency(amount)} added`);
        }

        function changeProductPrice(productId) {
            const product = stock.find(p => p.id === productId);
            if (!product) return;
            
            const newPrice = parseInt(prompt(`New price for ${product.name} (current: ${formatCurrency(product.price)}):`, product.price));
            if (newPrice && newPrice > 0) {
                product.price = newPrice;
                saveData('bizbook_stock', stock);
                refreshStock();
                alert(`‚úÖ Price updated: ${formatCurrency(newPrice)}`);
            }
        }

        function changeProductQuantity(productId) {
            const product = stock.find(p => p.id === productId);
            if (!product) return;
            
            const newQuantity = parseFloat(prompt(`New quantity for ${product.name} (current: ${product.quantity}${product.unit}):`, product.quantity));
            if (!isNaN(newQuantity) && newQuantity >= 0) {
                product.quantity = newQuantity;
                saveData('bizbook_stock', stock);
                refreshStock();
                refreshBuyList();
                alert(`‚úÖ Quantity updated: ${newQuantity}${product.unit}`);
            }
        }

        function setupSmartStock(productId) {
            const product = stock.find(p => p.id === productId);
            if (!product) return;
            
            const minStock = parseInt(prompt(`Reorder when stock reaches (current min: ${product.minStock}${product.unit}):`, product.minStock));
            if (minStock && minStock > 0) {
                product.minStock = minStock;
                saveData('bizbook_stock', stock);
                refreshStock();
                alert(`‚úÖ Min stock set to ${minStock}${product.unit}`);
            }
        }

        function deleteProduct(productId) {
            if (!confirm("Delete this product?")) return;
            
            const index = stock.findIndex(p => p.id === productId);
            if (index !== -1) {
                stock.splice(index, 1);
                saveData('bizbook_stock', stock);
                refreshStock();
                refreshBuyList();
                alert(`‚úÖ Product deleted`);
            }
        }

        // === INITIALIZATION ===
        refreshStock();
        refreshSales();
        refreshCash();
        refreshDebts();
        refreshBuyList();
        
        // Start tour for new users
        setTimeout(() => {
            if (!localStorage.getItem('tour_completed')) {
                startTour();
            }
        }, 1000);

        document.getElementById('morning-cash').addEventListener('input', updateCashCalculation);
        document.getElementById('expenses').addEventListener('input', updateCashCalculation);

        console.log('üì± BizBook v4 loaded!');
        </script>
    
    <!-- Service Worker -->
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("./service-worker.js")
                .then(() => console.log("Service Worker registered"))
                .catch(err => console.error("SW error", err));
        }
    </script>
</body>
</html>
