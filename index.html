<!DOCTYPE html>
<html lang="sw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biashara Sahihi - Tanzania</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { background: #f5f5f5; color: #333; padding-bottom: 80px; }
        header { background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%); color: white; padding: 15px; text-align: center; }
        h1 { font-size: 1.4rem; }
        .tabs { display: flex; background: white; border-bottom: 2px solid #2E8B57; }
        .tab-btn { flex: 1; padding: 12px 5px; border: none; background: white; font-size: 0.8rem; color: #555; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .tab-btn.active { background: #2E8B57; color: white; font-weight: bold; }
        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { color: #2E8B57; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9f9f9; border-radius: 5px; border-left: 4px solid #2E8B57; margin-bottom: 10px; }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: bold; }
        .item-detail { font-size: 0.9rem; color: #666; }
        .item-amount { font-weight: bold; color: #2E8B57; }
        .btn { background: #2E8B57; color: white; border: none; padding: 12px 20px; border-radius: 5px; font-size: 1rem; cursor: pointer; width: 100%; margin-top: 10px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat { background: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #2E8B57; }
        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px; display: flex; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .action-btn { flex: 1; padding: 12px; background: #2E8B57; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <header>
        <h1>üìì Biashara Sahihi</h1>
        <div>Vitabu 5 vya Biashara Yako</div>
    </header>
    
    <div class="tabs">
        <button class="tab-btn active" data-tab="bidhaa"><span>üì¶</span><span>Bidhaa</span></button>
        <button class="tab-btn" data-tab="mauzo"><span>üí∞</span><span>Mauzo</span></button>
        <button class="tab-btn" data-tab="fedha"><span>üè¶</span><span>Fedha</span></button>
        <button class="tab-btn" data-tab="deni"><span>üìù</span><span>Deni</span></button>
        <button class="tab-btn" data-tab="nunua"><span>üöö</span><span>Nunua</span></button>
    </div>
    
    <div id="bidhaa" class="tab-content active">
        <div class="card">
            <h3>üì¶ Bidhaa Zako</h3>
            <div class="item-list" id="stock-list"></div>
            <button class="btn" onclick="showAddProductForm()">+ Ongeza Bidhaa</button>
        </div>
    </div>
    
    <div id="mauzo" class="tab-content">
        <div class="stats">
            <div class="stat"><div class="stat-value" id="today-sales">TZS 0</div><div class="stat-label">Mauzo ya Leo</div></div>
            <div class="stat"><div class="stat-value" id="sales-count">0</div><div class="stat-label">Wateja Leo</div></div>
        </div>
        <div class="card">
            <h3>üí∞ Mauzo ya Leo</h3>
            <div class="item-list" id="sales-list"></div>
        </div>
    </div>
    
    <div id="fedha" class="tab-content">
        <div class="card">
            <h3>üè¶ Sanduku la Fedha</h3>
            <input type="number" id="morning-cash" placeholder="Fedha ya Asubuhi">
            <div class="item"><div class="item-info"><div class="item-name">Mauzo ya Leo</div></div><div class="item-amount" id="cash-sales-total">TZS 0</div></div>
            <input type="number" id="expenses" placeholder="Matumizi ya Leo">
            <div class="item"><div class="item-info"><div class="item-name">Fedha ya Jioni</div></div><div class="item-amount" id="expected-cash">TZS 0</div></div>
            <button class="btn" onclick="saveCash()">üíæ Hifadhi Fedha</button>
        </div>
    </div>
    
    <div id="deni" class="tab-content">
        <div class="card">
            <h3>üìù Wanaodeni</h3>
            <div class="item-list" id="debt-list"></div>
            <button class="btn" onclick="showAddDebtForm()">‚ûï Ongeza Deni</button>
        </div>
    </div>
    
    <div id="nunua" class="tab-content">
        <div class="card">
            <h3>üöö Nahitaji Kununua</h3>
            <div class="item-list" id="buy-list"></div>
            <div class="item"><div class="item-info"><div class="item-name">Gharama ya Takriban</div></div><div class="item-amount" id="total-cost">TZS 0</div></div>
            <button class="btn" onclick="createOrder()">üì± Tengeneza Oda</button>
        </div>
    </div>
    
    <!-- Forms (Hidden) -->
    <div id="add-product-form" class="tab-content hidden">
        <div class="card">
            <h3>‚ûï Ongeza Bidhaa</h3>
            <input type="text" id="product-name" placeholder="Jina la Bidhaa">
            <input type="number" id="product-quantity" placeholder="Idadi">
            <input type="number" id="product-price" placeholder="Bei ya Kuuza">
            <input type="number" id="product-cost" placeholder="Bei ya Ununuzi">
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="hideAddProductForm()">‚Ü©Ô∏è Rudi</button>
                <button class="btn" onclick="addProduct()">‚úì Hifadhi</button>
            </div>
        </div>
    </div>
    
    <div id="add-debt-form" class="tab-content hidden">
        <div class="card">
            <h3>‚ûï Ongeza Deni</h3>
            <input type="text" id="debt-customer" placeholder="J√ßina la Mteja">
            <input type="number" id="debt-amount" placeholder="Kiasi">
            <input type="tel" id="debt-phone" placeholder="Namba ya Simu">
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="hideAddDebtForm()">‚Ü©Ô∏è Rudi</button>
                <button class="btn" onclick="addDebt()">‚úì Hifadhi</button>
            </div>
        </div>
    </div>
    
    <div class="action-bar">
        <button class="action-btn" onclick="quickSale()">üí∞ Muuzo Haraka</button>
        <button class="action-btn" onclick="quickExpense()">üìù Matumizi</button>
        <button class="action-btn" onclick="exportData()">üì§ Hifadhi</button>
    </div>
    
<script>
// =========== DATA STORAGE ===========
function saveData(key, data) { 
    localStorage.setItem(key, JSON.stringify(data)); 
}

function loadData(key) { 
    const data = localStorage.getItem(key); 
    return data ? JSON.parse(data) : []; 
}

// Initialize data
let stock = loadData('biashara_stock') || [];
let sales = loadData('biashara_sales') || [];
let debts = loadData('biashara_debts') || [];
let cash = loadData('biashara_cash') || { morning: 0, expenses: 0 };

// Add sample data if empty
if (stock.length === 0) {
    stock = [
        { id: 1, name: "Soda", quantity: 24, price: 1000, cost: 700, minStock: 10 },
        { id: 2, name: "Maji", quantity: 12, price: 500, cost: 300, minStock: 5 },
        { id: 3, name: "Biscuit", quantity: 30, price: 300, cost: 200, minStock: 15 }
    ];
    saveData('biashara_stock', stock);
}

// =========== TAB SWITCHING ===========
document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', () => {
        const tabId = button.getAttribute('data-tab');
        
        // Update active tab button
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');
        
        // Show active tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
        
        // Refresh tab data
        if (tabId === 'bidhaa') refreshStock();
        if (tabId === 'mauzo') refreshSales();
        if (tabId === 'fedha') refreshCash();
        if (tabId === 'deni') refreshDebts();
        if (tabId === 'nunua') refreshBuyList();
    });
});

// =========== PRODUCT MANAGEMENT ===========
function refreshStock() {
    const stockList = document.getElementById('stock-list');
    
    if (stock.length === 0) {
        stockList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">Bado hakuna bidhaa. Bonyeza "Ongeza Bidhaa" kuanza.</div>';
        return;
    }
    
    stockList.innerHTML = stock.map(item => `
        <div class="item" onclick="showProductMenu(${item.id})">
            <div class="item-info">
                <div class="item-name">${item.name}</div>
                <div class="item-detail">Idadi: ${item.quantity} | Bei: ${formatCurrency(item.price)}</div>
            </div>
            <div class="item-amount">${item.quantity}</div>
        </div>
    `).join('');
}

function showProductMenu(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    const action = prompt(
        `${product.name}\nIdadi: ${product.quantity}\nBei: ${formatCurrency(product.price)}\n\nChagua:\n1. Fanya muuzo\n2. Badilisha bei\n3. Badilisha idadi\n4. Ondoa bidhaa\n\nIngiza namba (1-4):`,
        "1"
    );
    
    switch(action) {
        case "1": makeSaleFromProduct(productId); break;
        case "2": changeProductPrice(productId); break;
        case "3": changeProductQuantity(productId); break;
        case "4": deleteProduct(productId); break;
        default: break;
    }
}

function makeSaleFromProduct(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    const customer = prompt(`Mteja anunua ${product.name}. Jina la mteja:`, "Mteja");
    if (!customer) return;
    
    const quantity = parseInt(prompt(`Idadi ya ${product.name} (Zipo: ${product.quantity}):`, "1")) || 1;
    if (quantity > product.quantity) {
        alert(`Una ${product.quantity} tu ya ${product.name}!`);
        return;
    }
    
    const total = quantity * product.price;
    
    // Add sale
    const newSale = {
        id: Date.now(),
        customer: customer,
        product: product.name,
        quantity: quantity,
        total: total,
        date: new Date().toISOString(),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };
    
    sales.push(newSale);
    saveData('biashara_sales', sales);
    
    // Update stock
    product.quantity -= quantity;
    saveData('biashara_stock', stock);
    
    refreshSales();
    refreshStock();
    refreshBuyList();
    updateCashCalculation();
    
    alert(`‚úÖ ${customer} amenunua ${product.name} √ó ${quantity} = ${formatCurrency(total)}`);
}

function changeProductPrice(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    const newPrice = parseInt(prompt(`Bei mpya ya ${product.name} (sasa: ${formatCurrency(product.price)}):`, product.price));
    if (newPrice && newPrice > 0) {
        product.price = newPrice;
        saveData('biashara_stock', stock);
        refreshStock();
        alert(`‚úÖ Bei ya ${product.name} imebadilishwa: ${formatCurrency(newPrice)}`);
    }
}

function changeProductQuantity(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    const newQuantity = parseInt(prompt(`Idadi mpya ya ${product.name} (sasa: ${product.quantity}):`, product.quantity));
    if (!isNaN(newQuantity) && newQuantity >= 0) {
        product.quantity = newQuantity;
        saveData('biashara_stock', stock);
        refreshStock();
        refreshBuyList();
        alert(`‚úÖ Idadi ya ${product.name} imebadilishwa: ${newQuantity}`);
    }
}

function deleteProduct(productId) {
    if (!confirm("Unahakika unataka kufuta bidhaa hii?")) return;
    
    const productIndex = stock.findIndex(p => p.id === productId);
    if (productIndex !== -1) {
        const productName = stock[productIndex].name;
        stock.splice(productIndex, 1);
        saveData('biashara_stock', stock);
        refreshStock();
        refreshBuyList();
        alert(`‚úÖ ${productName} imefutwa`);
    }
}

// =========== SALES MANAGEMENT ===========
function refreshSales() {
    const today = new Date().toDateString();
    const todaySales = sales.filter(sale => new Date(sale.date).toDateString() === today);
    const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
    
    // Update stats
    document.getElementById('today-sales').textContent = formatCurrency(totalSales);
    document.getElementById('sales-count').textContent = todaySales.length;
    document.getElementById('cash-sales-total').textContent = formatCurrency(totalSales);
    
    // Update sales list
    const salesList = document.getElementById('sales-list');
    if (todaySales.length === 0) {
        salesList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">Bado hakuna mauzo leo</div>';
        return;
    }
    
    salesList.innerHTML = todaySales.map(sale => `
        <div class="item" onclick="showSaleMenu(${sale.id})">
            <div class="item-info">
                <div class="item-name">${sale.customer}</div>
                <div class="item-detail">${sale.product} √ó ${sale.quantity} | ${sale.time}</div>
            </div>
            <div class="item-amount">${formatCurrency(sale.total)}</div>
        </div>
    `).join('');
    
    updateCashCalculation();
}

function showSaleMenu(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) return;
    
    const action = prompt(
        `${sale.customer} - ${sale.product} √ó ${sale.quantity}\nJumla: ${formatCurrency(sale.total)}\nMuda: ${sale.time}\n\nChagua:\n1. Badilisha\n2. Ondoa\n3. Rudisha bidhaa\n\nIngiza namba (1-3):`,
        "1"
    );
    
    switch(action) {
        case "1": editSale(saleId); break;
        case "2": deleteSale(saleId); break;
        case "3": returnProduct(saleId); break;
        default: break;
    }
}

function editSale(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) return;
    
    const newCustomer = prompt("Jina jipya la mteja:", sale.customer);
    if (newCustomer) sale.customer = newCustomer;
    
    const newQuantity = parseInt(prompt(`Idadi jipya ya ${sale.product}:`, sale.quantity));
    if (!isNaN(newQuantity) && newQuantity > 0) {
        // Find the product to check stock
        const product = stock.find(p => p.name === sale.product);
        if (product) {
            const quantityDiff = newQuantity - sale.quantity;
            if (quantityDiff > product.quantity) {
                alert(`Una ${product.quantity} tu ya ${sale.product}`);
                return;
            }
            
            // Update stock
            product.quantity -= quantityDiff;
            sale.quantity = newQuantity;
            sale.total = newQuantity * (sale.total / sale.quantity); // Adjust total
        }
    }
    
    saveData('biashara_sales', sales);
    saveData('biashara_stock', stock);
    refreshSales();
    refreshStock();
    updateCashCalculation();
    alert("‚úÖ Muuzo umebadilishwa");
}

function deleteSale(saleId) {
    if (!confirm("Unahakika unataka kufuta muuzo huu?")) return;
    
    const saleIndex = sales.findIndex(s => s.id === saleId);
    if (saleIndex !== -1) {
        const sale = sales[saleIndex];
        
        // Return product to stock
        const product = stock.find(p => p.name === sale.product);
        if (product) {
            product.quantity += sale.quantity;
            saveData('biashara_stock', stock);
        }
        
        // Remove sale
        sales.splice(saleIndex, 1);
        saveData('biashara_sales', sales);
        
        refreshSales();
        refreshStock();
        updateCashCalculation();
        alert("‚úÖ Muuzo umefutwa");
    }
}

function returnProduct(saleId) {
    const sale = sales.find(s => s.id === saleId);
    if (!sale) return;
    
    const returnQty = parseInt(prompt(`Idadi ya ${sale.product} kurudisha (iliyonunuliwa: ${sale.quantity}):`, sale.quantity));
    if (!isNaN(returnQty) && returnQty > 0 && returnQty <= sale.quantity) {
        const product = stock.find(p => p.name === sale.product);
        if (product) {
            // Return to stock
            product.quantity += returnQty;
            
            // Reduce sale quantity or remove if all returned
            if (returnQty === sale.quantity) {
                // Delete the sale
                const saleIndex = sales.findIndex(s => s.id === saleId);
                sales.splice(saleIndex, 1);
            } else {
                // Reduce sale quantity
                sale.quantity -= returnQty;
                sale.total = sale.quantity * (sale.total / (sale.quantity + returnQty));
            }
            
            saveData('biashara_stock', stock);
            saveData('biashara_sales', sales);
            
            refreshSales();
            refreshStock();
            updateCashCalculation();
            alert(`‚úÖ ${returnQty} ${sale.product} zimerudishwa kwenye hisa`);
        }
    }
    }

// =========== CASH MANAGEMENT ===========
function refreshCash() {
    const todaySales = sales.filter(sale => 
        new Date(sale.date).toDateString() === new Date().toDateString()
    );
    const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
    
    document.getElementById('morning-cash').value = cash.morning || '';
    document.getElementById('expenses').value = cash.expenses || '';
    document.getElementById('cash-sales-total').textContent = formatCurrency(totalSales);
    
    updateCashCalculation();
}

function updateCashCalculation() {
    const morningCash = parseFloat(document.getElementById('morning-cash').value) || 0;
    const todaySales = sales.filter(sale => 
        new Date(sale.date).toDateString() === new Date().toDateString()
    );
    const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
    const expenses = parseFloat(document.getElementById('expenses').value) || 0;
    
    const expectedCash = morningCash + totalSales - expenses;
    document.getElementById('expected-cash').textContent = formatCurrency(expectedCash);
}

function saveCash() {
    const morningCash = parseFloat(document.getElementById('morning-cash').value) || 0;
    const expenses = parseFloat(document.getElementById('expenses').value) || 0;
    
    cash = {
        morning: morningCash,
        expenses: expenses,
        lastUpdated: new Date().toISOString()
    };
    
    saveData('biashara_cash', cash);
    alert('‚úÖ Fedha zimehifadhiwa!');
}

// =========== DEBT MANAGEMENT ===========
function refreshDebts() {
    const debtList = document.getElementById('debt-list');
    
    if (debts.length === 0) {
        debtList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">Hakuna madeni kwa sasa</div>';
        return;
    }
    
    debtList.innerHTML = debts.map(debt => `
        <div class="item" onclick="showDebtMenu(${debt.id})">
            <div class="item-info">
                <div class="item-name">${debt.customer}</div>
                <div class="item-detail">${debt.date} ${debt.phone ? `| ${debt.phone}` : ''}</div>
            </div>
            <div class="item-amount">${formatCurrency(debt.amount)}</div>
        </div>
    `).join('');
}

function showDebtMenu(debtId) {
    const debt = debts.find(d => d.id === debtId);
    if (!debt) return;
    
    const action = prompt(
        `${debt.customer}\nDeni: ${formatCurrency(debt.amount)}\nTarehe: ${debt.date}\n\nChagua:\n1. Lipa deni\n2. Badilisha\n3. Ondoa\n\nIngiza namba (1-3):`,
        "1"
    );
    
    switch(action) {
        case "1": payDebt(debtId); break;
        case "2": editDebt(debtId); break;
        case "3": deleteDebt(debtId); break;
        default: break;
    }
}

function payDebt(debtId) {
    const debt = debts.find(d => d.id === debtId);
    if (!debt) return;
    
    const amountPaid = parseFloat(prompt(`Kiasi kilicholipwa (deni: ${formatCurrency(debt.amount)}):`, debt.amount));
    if (amountPaid && amountPaid > 0) {
        if (amountPaid >= debt.amount) {
            // Full payment
            alert(`‚úÖ ${debt.customer} amelipa deni lote la ${formatCurrency(debt.amount)}`);
            const debtIndex = debts.findIndex(d => d.id === debtId);
            debts.splice(debtIndex, 1);
        } else {
            // Partial payment
            debt.amount -= amountPaid;
            alert(`‚úÖ ${debt.customer} amelipa ${formatCurrency(amountPaid)}, bado ana ${formatCurrency(debt.amount)}`);
        }
        
        saveData('biashara_debts', debts);
        refreshDebts();
    }
}

function editDebt(debtId) {
    const debt = debts.find(d => d.id === debtId);
    if (!debt) return;
    
    const newAmount = parseInt(prompt(`Kiasi kipya cha deni (sasa: ${formatCurrency(debt.amount)}):`, debt.amount));
    if (newAmount && newAmount > 0) debt.amount = newAmount;
    
    const newPhone = prompt(`Namba mpya ya simu (sasa: ${debt.phone || 'Hakuna'}):`, debt.phone || '');
    if (newPhone !== null) debt.phone = newPhone;
    
    saveData('biashara_debts', debts);
    refreshDebts();
    alert("‚úÖ Deni limebadilishwa");
}

function deleteDebt(debtId) {
    if (!confirm("Unahakika unataka kufuta deni hili?")) return;
    
    const debtIndex = debts.findIndex(d => d.id === debtId);
    if (debtIndex !== -1) {
        const debt = debts[debtIndex];
        debts.splice(debtIndex, 1);
        saveData('biashara_debts', debts);
        refreshDebts();
        alert(`‚úÖ Deni la ${debt.customer} limefutwa`);
    }
}

// =========== BUY LIST MANAGEMENT ===========
function refreshBuyList() {
    const buyList = document.getElementById('buy-list');
    let itemsToBuy = [];
    let totalCost = 0;
    
    stock.forEach(item => {
        if (item.quantity <= item.minStock) {
            const needed = item.minStock * 3 - item.quantity;
            const cost = needed * item.cost;
            itemsToBuy.push({
                name: item.name,
                needed: needed,
                current: item.quantity,
                cost: cost
            });
            totalCost += cost;
        }
    });
    
    document.getElementById('total-cost').textContent = formatCurrency(totalCost);
    
    if (itemsToBuy.length === 0) {
        buyList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">Huna hitaji la kununua bidhaa kwa sasa</div>';
        return;
    }
    
    buyList.innerHTML = itemsToBuy.map(item => `
        <div class="item">
            <div class="item-info">
                <div class="item-name">${item.name}</div>
                <div class="item-detail">Inahitajika: ${item.needed} (sasa: ${item.current})</div>
            </div>
            <div class="item-amount">${formatCurrency(item.cost)}</div>
        </div>
    `).join('');
}

function createOrder() {
    let itemsToBuy = [];
    let totalCost = 0;
    
    stock.forEach(item => {
        if (item.quantity <= item.minStock) {
            const needed = item.minStock * 3 - item.quantity;
            const cost = needed * item.cost;
            itemsToBuy.push({
                name: item.name,
                needed: needed,
                cost: cost
            });
            totalCost += cost;
        }
    });
    
    if (itemsToBuy.length === 0) {
        alert('Huna hitaji la kununua bidhaa kwa sasa');
        return;
    }
    
    const orderText = itemsToBuy.map(item => 
        `${item.name}: ${item.needed}`
    ).join(', ');
    
    const message = `Habari, nahitaji kununua: ${orderText}. Jumla ya takriban: ${formatCurrency(totalCost)}.`;
    
    // Open WhatsApp with message
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

// =========== QUICK EXPENSE ===========
function quickExpense() {
    const amount = parseFloat(prompt('Kiasi cha matumizi (TZS):', '')) || 0;
    const reason = prompt('Sababu ya matumizi (mfano: Umeme, Usafiri):', '') || 'Matumizi';
    
    if (amount <= 0) {
        alert('Tafadhali ingiza kiasi cha matumizi');
        return;
    }
    
    // Update expenses in cash
    const currentExpenses = cash.expenses || 0;
    cash.expenses = currentExpenses + amount;
    saveData('biashara_cash', cash);
    
    // Update cash display
    document.getElementById('expenses').value = cash.expenses;
    updateCashCalculation();
    
    alert(`‚úÖ Matumizi: ${reason} - ${formatCurrency(amount)} yameongezwa`);
}

// =========== QUICK SALE (from bottom button) ===========
function quickSale() {
    if (stock.length === 0) {
        alert('Kwanza ongeza bidhaa zako kwenye kichupo cha "Bidhaa"');
        return;
    }
    
    const customer = prompt('Jina la mteja:') || 'Mteja';
    const productNames = stock.map(item => item.name).join(', ');
    const productName = prompt(`Bidhaa gani? (${productNames}):`);
    
    const product = stock.find(item => item.name.toLowerCase() === productName?.toLowerCase());
    if (!product) {
        alert('Bidhaa hiyo haipo. Tafadhali chagua moja ya bidhaa zilizopo.');
        return;
    }
    
    const quantity = parseInt(prompt(`Idadi ya ${product.name}:`, '1')) || 1;
    
    if (quantity > product.quantity) {
        alert(`Samahani, una ${product.quantity} tu ya ${product.name}`);
        return;
    }
    
    const total = quantity * product.price;
    
    // Add sale
    const newSale = {
        id: Date.now(),
        customer: customer,
        product: product.name,
        quantity: quantity,
        total: total,
        date: new Date().toISOString(),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };
    
    sales.push(newSale);
    saveData('biashara_sales', sales);
    
    // Update stock
    product.quantity -= quantity;
    saveData('biashara_stock', stock);
    
    // Refresh displays
    refreshSales();
    refreshStock();
    refreshBuyList();
    updateCashCalculation();
    
    alert(`‚úÖ ${customer}: ${product.name} √ó ${quantity} = ${formatCurrency(total)}`);
}

// =========== EXPORT DATA ===========
function exportData() {
    const allData = {
        stock: stock,
        sales: sales,
        debts: debts,
        cash: cash,
        exported: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(allData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `biashara-data-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// =========== PRODUCT FORM FUNCTIONS ===========
function showAddProductForm() {
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById('add-product-form').classList.add('active');
}

function hideAddProductForm() {
    document.getElementById('add-product-form').classList.remove('active');
    document.getElementById('bidhaa').classList.add('active');
    
    // Reset active tab button
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-tab') === 'bidhaa') {
            btn.classList.add('active');
        }
    });
}

function addProduct() {
    const name = document.getElementById('product-name').value;
    const quantity = parseInt(document.getElementById('product-quantity').value) || 0;
    const price = parseInt(document.getElementById('product-price').value) || 0;
    const cost = parseInt(document.getElementById('product-cost').value) || 0;
    
    if (!name) {
        alert('Tafadhali ingiza jina la bidhaa');
        return;
    }
    
    const newProduct = {
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        minStock: 10
    };
    
    stock.push(newProduct);
    saveData('biashara_stock', stock);
    
    // Clear form
    document.getElementById('product-name').value = '';
    document.getElementById('product-quantity').value = '';
    document.getElementById('product-price').value = '';
    document.getElementById('product-cost').value = '';
    
    hideAddProductForm();
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} imeongezwa kwenye bidhaa zako`);
}

// =========== DEBT FORM FUNCTIONS ===========
function showAddDebtForm() {
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById('add-debt-form').classList.add('active');
}

function hideAddDebtForm() {
    document.getElementById('add-debt-form').classList.remove('active');
    document.getElementById('deni').classList.add('active');
    
    // Reset active tab button
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-tab') === 'deni') {
            btn.classList.add('active');
        }
    });
}

function addDebt() {
    const customer = document.getElementById('debt-customer').value;
    const amount = parseInt(document.getElementById('debt-amount').value) || 0;
    const phone = document.getElementById('debt-phone').value;
    
    if (!customer || amount <= 0) {
        alert('Tafadhali ingiza jina la mteja na kiasi cha deni');
        return;
    }
    
    const newDebt = {
        id: Date.now(),
        customer: customer,
        amount: amount,
        phone: phone,
        date: new Date().toLocaleDateString('sw-TZ')
    };
    
    debts.push(newDebt);
    saveData('biashara_debts', debts);
    
    // Clear form
    document.getElementById('debt-customer').value = '';
    document.getElementById('debt-amount').value = '';
    document.getElementById('debt-phone').value = '';
    
    hideAddDebtForm();
    refreshDebts();
    
    alert(`‚úÖ Deni la ${formatCurrency(amount)} limeongezwa kwa ${customer}`);
}

// =========== UTILITY FUNCTIONS ===========
function formatCurrency(amount) {
    return new Intl.NumberFormat('sw-TZ', {
        style: 'currency',
        currency: 'TZS',
        minimumFractionDigits: 0
    }).format(amount);
}

// =========== INITIAL LOAD ===========
// Load initial data
refreshStock();
refreshSales();
refreshCash();
refreshDebts();
refreshBuyList();

// Set up event listeners for cash calculation
document.getElementById('morning-cash').addEventListener('input', updateCashCalculation);
document.getElementById('expenses').addEventListener('input', updateCashCalculation);

console.log('üì± Biashara Sahihi loaded successfully!');
</script>
</body>
</html>
