<!DOCTYPE html>
<html lang="sw">
<head>
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2E8B57">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizBook</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: Arial, sans-serif; }
        body { background: #f5f5f5; color: #333; padding-bottom: 80px; }
        header { background: linear-gradient(135deg, #2E8B57 0%, #228B22 100%); color: white; padding: 15px; text-align: center; }
        h1 { font-size: 1.4rem; }
        .tabs { display: flex; background: white; border-bottom: 2px solid #2E8B57; }
        .tab-btn { flex: 1; padding: 12px 5px; border: none; background: white; font-size: 0.8rem; color: #555; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .tab-btn.active { background: #2E8B57; color: white; font-weight: bold; }
        .tab-content { display: none; padding: 15px; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h3 { color: #2E8B57; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f9f9f9; border-radius: 5px; border-left: 4px solid #2E8B57; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .item:hover { background: #e8f5e9; transform: translateY(-2px); }
        .item-info { display: flex; flex-direction: column; }
        .item-name { font-weight: bold; }
        .item-detail { font-size: 0.9rem; color: #666; }
        .item-amount { font-weight: bold; color: #2E8B57; }
        .btn { background: #2E8B57; color: white; border: none; padding: 12px 20px; border-radius: 5px; font-size: 1rem; cursor: pointer; width: 100%; margin-top: 10px; }
        .stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat { background: white; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #2E8B57; }
        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 10px; display: flex; gap: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .action-btn { flex: 1; padding: 12px; background: #2E8B57; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; margin-left: 5px; }
        .badge-danger { background: #e74c3c; color: white; }
        .badge-warning { background: #f39c12; color: white; }
        .badge-success { background: #2ecc71; color: white; }
    </style>
<script data-goatcounter="https://bizbook.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
    
</head>

    <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js")
    .then(() => console.log("Service Worker registered"))
    .catch(err => console.error("SW error", err));
}
    </script>
    
<body>
    <header>
        <h1>üìì BizBook</h1>
        </header>
    
    <div class="tabs">
        <button class="tab-btn active" data-tab="bidhaa"><span>üì¶</span><span>Products</span></button>
        <button class="tab-btn" data-tab="mauzo"><span>üí∞</span><span>Sales</span></button>
        <button class="tab-btn" data-tab="fedha"><span>üè¶</span><span>Cash</span></button>
        <button class="tab-btn" data-tab="deni"><span>üìù</span><span>Debts</span></button>
        <button class="tab-btn" data-tab="nunua"><span>üöö</span><span>Buy</span></button>
    </div>
    
    <div id="bidhaa" class="tab-content active">
        <div class="card">
            <h3>üì¶ Your Products</h3>
            <div class="item-list" id="stock-list"></div>
            <button class="btn" onclick="addProduct()">+ Add Product</button>
        </div>
    </div>
    
    <div id="mauzo" class="tab-content">
        <div class="stats">
            <div class="stat"><div class="stat-value" id="today-sales">TZS 0</div><div class="stat-label">Today's Sales</div></div>
            <div class="stat"><div class="stat-value" id="sales-count">0</div><div class="stat-label">Customers</div></div>
        </div>
        <div class="card">
            <h3>üí∞ Today's Sales</h3>
            <div class="item-list" id="sales-list"></div>
        </div>
    </div>
    
    <div id="fedha" class="tab-content">
        <div class="card">
            <h3>üè¶ Cash Box</h3>
            <input type="number" id="morning-cash" placeholder="Morning Cash">
            <div class="item"><div class="item-info"><div class="item-name">Today's Sales</div></div><div class="item-amount" id="cash-sales-total">TZS 0</div></div>
            <input type="number" id="expenses" placeholder="Today's Expenses">
            <div class="item"><div class="item-info"><div class="item-name">Evening Cash</div></div><div class="item-amount" id="expected-cash">TZS 0</div></div>
            <button class="btn" onclick="saveCash()">üíæ Save Cash</button>
        </div>
    </div>
    
    <div id="deni" class="tab-content">
        <div class="card">
            <h3>üìù Money Owed</h3>
            <div class="item-list" id="debt-list"></div>
            <button class="btn" onclick="addDebtUSSD()">‚ûï Add Debt</button>
        </div>
    </div>
    
    <div id="nunua" class="tab-content">
        <div class="card">
            <h3>üöö Need to Buy</h3>
            <div class="item-list" id="buy-list"></div>
            <div class="item"><div class="item-info"><div class="item-name">Approx Cost</div></div><div class="item-amount" id="total-cost">TZS 0</div></div>
            <button class="btn" onclick="createSmartOrder()">üì± Create Order</button>
        </div>
    </div>
    
    <div class="action-bar">
        <button class="action-btn" onclick="showMenu()">
    <span>‚öôÔ∏è</span>
    <span>Menu</span>
        </button>
        <button class="action-btn" onclick="quickSale()">üí∞ Quick Sale</button>
        <button class="action-btn" onclick="quickExpense()">üìù Expense</button>
        <button class="action-btn" onclick="exportData()">üì§ Export</button>
            </div>

        <script>
function saveData(key, data) { 
    localStorage.setItem(key, JSON.stringify(data)); 
}

function loadData(key) { 
    const data = localStorage.getItem(key); 
    return data ? JSON.parse(data) : []; 
}

let stock = loadData('bizbook_stock') || [];
let sales = loadData('bizbook_sales') || [];
let debts = loadData('bizbook_debts') || [];
let cash = loadData('bizbook_cash') || { morning: 0, expenses: 0 };

if (stock.length === 0) {
    // Empty stock - user will add their own products
    saveData('bizbook_stock', stock);
            }

document.querySelectorAll('.tab-btn').forEach(button => {
    button.addEventListener('click', () => {
        const tabId = button.getAttribute('data-tab');
        
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        button.classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
        
        if (tabId === 'bidhaa') refreshStock();
        if (tabId === 'mauzo') refreshSales();
        if (tabId === 'fedha') refreshCash();
        if (tabId === 'deni') refreshDebts();
        if (tabId === 'nunua') refreshBuyList();
    });
});

function addProduct() {
    const saleMethod = prompt(
        "How is this product SOLD?\n\n" +
        "1. By piece (individual items)\n" +
        "2. By weight (kilos, grams)\n" +
        "3. By volume (liters, milliliters)\n" +
        "4. From cartons/boxes\n" +
        "5. By length (meters, yards)\n" +
        "6. Other way\n\n" +
        "Enter number (1-6):",
        "1"
    );
    
    switch(saleMethod) {
        case "1": addPieceProduct(); break;
        case "2": addWeightProduct(); break;
        case "3": addVolumeProduct(); break;
        case "4": addCartonProduct(); break;
        case "5": addLengthProduct(); break;
        case "6": addCustomProduct(); break;
        default: addPieceProduct(); break;
    }
}

function addPieceProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const quantity = parseInt(prompt("Current quantity (pieces):", "100")) || 0;
    const price = parseInt(prompt("Selling price per piece (TZS):", "1000")) || 0;
    const cost = parseInt(prompt("Purchase cost per piece (TZS):", "700")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        unit: "pcs",
        minStock: Math.ceil(quantity * 0.3),
        orderQuantity: quantity
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${quantity} pieces\nSell: ${formatCurrency(price)}/piece`);
}

function addCartonProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const itemsPerCarton = parseInt(prompt("How many items in ONE carton/box?", "24")) || 24;
    const cartonCost = parseInt(prompt("Cost per CARTON (TZS):", "24000")) || 0;
    const itemPrice = parseInt(prompt("Selling price per ITEM (TZS):", "1500")) || 0;
    
    const costPerItem = cartonCost / itemsPerCarton;
    
    const cartonsInStock = parseInt(prompt("How many cartons do you have?", "10")) || 0;
    const totalItems = cartonsInStock * itemsPerCarton;
    
    const openItems = parseInt(prompt("How many items are already opened/sold individually?", "0")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: totalItems,
        price: itemPrice,
        cost: costPerItem,
        minStock: itemsPerCarton * 2,
        orderQuantity: itemsPerCarton,
        unit: "pcs",
        cartonSize: itemsPerCarton,
        cartonCost: cartonCost,
        wholeCartons: cartonsInStock - Math.ceil(openItems / itemsPerCarton),
        openItems: openItems % itemsPerCarton,
        itemType: "item"
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${cartonsInStock} cartons (${totalItems} items)\nBuy carton: ${formatCurrency(cartonCost)}\nSell per item: ${formatCurrency(itemPrice)}`);
}

function addWeightProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const unitType = prompt("Weight unit:\n1. Kilos (kg)\n2. Grams (g)\n3. Tonnes\n\nEnter number:", "1");
    const units = ['kg', 'g', 'tonne'];
    const unit = units[parseInt(unitType) - 1] || 'kg';
    
    const quantity = parseFloat(prompt(`Current quantity in ${unit}:`, unit === 'kg' ? "100" : "1000")) || 0;
    const price = parseInt(prompt(`Selling price per ${unit} (TZS):`, "2000")) || 0;
    const cost = parseInt(prompt(`Purchase cost per ${unit} (TZS):`, "1500")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        unit: unit,
        minStock: Math.ceil(quantity * 0.2),
        orderQuantity: quantity
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${quantity}${unit}\nSell: ${formatCurrency(price)}/${unit}`);
}

function addVolumeProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const unitType = prompt("Volume unit:\n1. Liters (L)\n2. Milliliters (ml)\n\nEnter number:", "1");
    const units = ['liter', 'ml'];
    const unit = units[parseInt(unitType) - 1] || 'liter';
    
    const quantity = parseFloat(prompt(`Current quantity in ${unit}:`, unit === 'liter' ? "20" : "1000")) || 0;
    const price = parseInt(prompt(`Selling price per ${unit} (TZS):`, "3000")) || 0;
    const cost = parseInt(prompt(`Purchase cost per ${unit} (TZS):`, "2000")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        unit: unit,
        minStock: Math.ceil(quantity * 0.2),
        orderQuantity: quantity
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${quantity}${unit}\nSell: ${formatCurrency(price)}/${unit}`);
}

function addLengthProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const unitType = prompt("Length unit:\n1. Meters (m)\n2. Yards (yd)\n\nEnter number:", "1");
    const units = ['meter', 'yard'];
    const unit = units[parseInt(unitType) - 1] || 'meter';
    
    const quantity = parseFloat(prompt(`Current quantity in ${unit}:`, unit === 'meter' ? "50" : "100")) || 0;
    const price = parseInt(prompt(`Selling price per ${unit} (TZS):`, "5000")) || 0;
    const cost = parseInt(prompt(`Purchase cost per ${unit} (TZS):`, "4000")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        unit: unit,
        minStock: Math.ceil(quantity * 0.2),
        orderQuantity: quantity
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${quantity}${unit}\nSell: ${formatCurrency(price)}/${unit}`);
            }
            
function addCustomProduct() {
    const name = prompt("Product name:", "");
    if (!name) return;
    
    const customUnit = prompt("What unit do you use? (e.g., bunch, bundle, pair):", "bunch");
    const quantity = parseFloat(prompt(`Current quantity in ${customUnit}:`, "50")) || 0;
    const price = parseInt(prompt(`Selling price per ${customUnit} (TZS):`, "2000")) || 0;
    const cost = parseInt(prompt(`Purchase cost per ${customUnit} (TZS):`, "1500")) || 0;
    
    stock.push({
        id: Date.now(),
        name: name,
        quantity: quantity,
        price: price,
        cost: cost,
        unit: customUnit,
        minStock: Math.ceil(quantity * 0.3),
        orderQuantity: quantity
    });
    
    saveData('bizbook_stock', stock);
    refreshStock();
    refreshBuyList();
    
    alert(`‚úÖ ${name} added!\n${quantity} ${customUnit}\nSell: ${formatCurrency(price)}/${customUnit}`);
}

            function refreshStock() {
    const stockList = document.getElementById('stock-list');
    
    if (stock.length === 0) {
        stockList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">No products. Click "Add Product" to start.</div>';
        return;
    }
    
    stockList.innerHTML = stock.map(item => {
        if (item.cartonSize) {
            const fullCartons = Math.floor((item.quantity - (item.openItems || 0)) / item.cartonSize);
            const itemType = item.itemType || "item";
            
            let badge = '';
            if (item.quantity === 0) {
                badge = '<span class="badge badge-danger">Empty!</span>';
            } else if (item.quantity <= item.minStock) {
                badge = '<span class="badge badge-warning">Reorder</span>';
            }
            
            return `
                <div class="item" onclick="showProductMenu(${item.id})">
                    <div class="item-info">
                        <div class="item-name">${item.name} üì¶ ${badge}</div>
                        <div class="item-detail">
                            ${item.quantity} ${itemType}s total<br>
                            ${fullCartons} full cartons + ${item.openItems || 0} open ${itemType}s<br>
                            Sell: ${formatCurrency(item.price)}/${itemType}
                        </div>
                    </div>
                    <div class="item-amount">
                        ${fullCartons}üì¶<br>
                        ${item.openItems || 0}üü¢
                    </div>
                </div>
            `;
        }
        
        let badge = '';
        const stockPercent = (item.quantity / item.minStock) * 100;
        
        if (item.quantity === 0) {
            badge = '<span class="badge badge-danger">Empty!</span>';
        } else if (item.quantity <= item.minStock * 0.5) {
            badge = '<span class="badge badge-danger">Low!</span>';
        } else if (item.quantity <= item.minStock) {
            badge = '<span class="badge badge-warning">Reorder</span>';
        } else if (stockPercent < 150) {
            badge = '<span class="badge badge-success">OK</span>';
        }
        
        return `
            <div class="item" onclick="showProductMenu(${item.id})">
                <div class="item-info">
                    <div class="item-name">${item.name} ${badge}</div>
                    <div class="item-detail">
                        ${item.quantity}${item.unit || ''} | 
                        Sell: ${formatCurrency(item.price)}/${item.unit || 'unit'} |
                        Min: ${item.minStock || 0}${item.unit || ''}
                    </div>
                </div>
                <div class="item-amount">${item.quantity}</div>
            </div>
        `;
    }).join('');
}

function showProductMenu(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    const isCarton = product.cartonSize;
    
    const options = isCarton 
        ? `1. Make sale\n2. Change price\n3. Change quantity\n4. Set reorder logic\n5. View carton details\n6. Remove product`
        : `1. Make sale\n2. Change price\n3. Change quantity\n4. Set reorder logic\n5. Remove product`;
    
    const action = prompt(
        `${product.name}\nQuantity: ${product.quantity}${product.unit}\nPrice: ${formatCurrency(product.price)}/${product.unit}\nMin stock: ${product.minStock}${product.unit}\n\nChoose:\n${options}\n\nEnter number:`,
        "1"
    );
    
    if (isCarton) {
        switch(action) {
            case "1": makeCartonSale(productId); break;
            case "2": changeProductPrice(productId); break;
            case "3": changeProductQuantity(productId); break;
            case "4": setupSmartStock(productId); break;
            case "5": showCartonDetails(productId); break;
            case "6": deleteProduct(productId); break;
            default: break;
        }
    } else {
        switch(action) {
            case "1": makeSaleWithUnits(productId); break;
            case "2": changeProductPrice(productId); break;
            case "3": changeProductQuantity(productId); break;
            case "4": setupSmartStock(productId); break;
            case "5": deleteProduct(productId); break;
            default: break;
        }
    }
}

function makeCartonSale(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product || !product.cartonSize) return makeSaleWithUnits(productId);
    
    const customer = prompt("Customer name:", "Customer");
    const itemName = product.itemType || "item";
    
    const saleType = prompt(
        `Sell ${product.name} as:\n1. Single ${itemName}\n2. Whole carton (${product.cartonSize} ${itemName}s)\n3. Multiple ${itemName}s\n\nEnter choice:`,
        "1"
    );
    
    let quantity;
    let unit;
    
    switch(saleType) {
        case "1": quantity = 1; unit = itemName; break;
        case "2": quantity = product.cartonSize; unit = "carton"; break;
        case "3": quantity = parseInt(prompt(`How many ${itemName}s? (Available: ${product.quantity}):`, "2")) || 0; unit = itemName + "s"; break;
        default: return;
    }
    
    if (quantity > product.quantity) {
        alert(`Only ${product.quantity} ${itemName}s available!`);
        return;
    }
    
    const total = quantity * product.price;
    
    product.quantity -= quantity;
    
    if (product.cartonSize) {
        if (product.openItems >= quantity) {
            product.openItems -= quantity;
        } else {
            const remaining = quantity - product.openItems;
            product.openItems = product.cartonSize - (remaining % product.cartonSize);
            if (product.openItems === product.cartonSize) product.openItems = 0;
            product.wholeCartons = Math.floor((product.quantity - product.openItems) / product.cartonSize);
        }
    }
    
    const sale = {
        id: Date.now(),
        customer: customer,
        product: product.name,
        quantity: quantity,
        unit: unit,
        total: total,
        date: new Date().toISOString(),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };
    
    sales.push(sale);
    saveData('bizbook_sales', sales);
    saveData('bizbook_stock', stock);
    
    refreshSales();
    refreshStock();
    updateCashCalculation();
    
    const message = saleType === "2" 
        ? `‚úÖ ${customer} bought 1 carton of ${product.name} (${quantity} ${itemName}s) = ${formatCurrency(total)}`
        : `‚úÖ ${customer} bought ${quantity} ${unit} of ${product.name} = ${formatCurrency(total)}`;
    
    alert(message);
}

function showCartonDetails(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product || !product.cartonSize) return;
    
    const fullCartons = Math.floor((product.quantity - (product.openItems || 0)) / product.cartonSize);
    
    alert(
        `üì¶ ${product.name} Carton Details:\n\n` +
        `‚Ä¢ Carton size: ${product.cartonSize} items\n` +
        `‚Ä¢ Cost per carton: ${formatCurrency(product.cartonCost)}\n` +
        `‚Ä¢ Cost per item: ${formatCurrency(product.cost)}\n` +
        `‚Ä¢ Sell per item: ${formatCurrency(product.price)}\n` +
        `‚Ä¢ Current stock: ${product.quantity} items\n` +
        `‚Ä¢ Full cartons: ${fullCartons}\n` +
        `‚Ä¢ Open items: ${product.openItems || 0}\n` +
        `‚Ä¢ Reorder at: ${product.minStock} items`
    );
}

function makeSaleWithUnits(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    const customer = prompt(`Customer buys ${product.name}. Customer name:`, "Customer");
    if (!customer) return;
    
    const quantity = parseFloat(prompt(
        `${product.name} (available: ${product.quantity}${product.unit})\nPrice: ${formatCurrency(product.price)}/${product.unit}\n\nQuantity in ${product.unit}:`,
        product.unit === 'pcs' ? "1" : product.unit === 'kg' ? "0.5" : "1"
    )) || 0;
    
    if (quantity > product.quantity) {
        alert(`Only ${product.quantity}${product.unit} of ${product.name} available!`);
        return;
    }
    
    const total = quantity * product.price;
    
    const newSale = {
        id: Date.now(),
        customer: customer,
        product: product.name,
        quantity: quantity,
        unit: product.unit,
        total: total,
        date: new Date().toISOString(),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };
    
    sales.push(newSale);
    saveData('bizbook_sales', sales);
    
    product.quantity -= quantity;
    saveData('bizbook_stock', stock);
    
    refreshSales();
    refreshStock();
    refreshBuyList();
    updateCashCalculation();
    
    alert(`‚úÖ ${customer} bought ${product.name} √ó ${quantity}${product.unit} = ${formatCurrency(total)}`);
}

function changeProductPrice(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    const newPrice = parseInt(prompt(`New price for ${product.name} per ${product.unit} (current: ${formatCurrency(product.price)}/${product.unit}):`, product.price));
    if (newPrice && newPrice > 0) {
        product.price = newPrice;
        saveData('bizbook_stock', stock);
        refreshStock();
        alert(`‚úÖ Price of ${product.name} changed: ${formatCurrency(newPrice)}/${product.unit}`);
    }
}

function changeProductQuantity(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    const newQuantity = parseFloat(prompt(`New quantity for ${product.name} in ${product.unit} (current: ${product.quantity}${product.unit}):`, product.quantity));
    if (!isNaN(newQuantity) && newQuantity >= 0) {
        product.quantity = newQuantity;
        
        if (product.cartonSize) {
            product.wholeCartons = Math.floor(newQuantity / product.cartonSize);
            product.openItems = newQuantity % product.cartonSize;
        }
        
        saveData('bizbook_stock', stock);
        refreshStock();
        refreshBuyList();
        alert(`‚úÖ Quantity of ${product.name} changed: ${newQuantity}${product.unit}`);
    }
}

function deleteProduct(productId) {
    if (!confirm("Are you sure you want to delete this product?")) return;
    
    const productIndex = stock.findIndex(p => p.id === productId);
    if (productIndex !== -1) {
        const productName = stock[productIndex].name;
        stock.splice(productIndex, 1);
        saveData('bizbook_stock', stock);
        refreshStock();
        refreshBuyList();
        alert(`‚úÖ ${productName} deleted`);
    }
}

function setupSmartStock(productId) {
    const product = stock.find(p => p.id === productId);
    if (!product) return;
    
    alert(`${product.name} (${product.quantity}${product.unit})`);
    
    const logic = prompt(
        `FOR ${product.name.toUpperCase()}:\n\nWhen should you reorder?\n\nExample:\n- Soda: "I have 24, I reorder when I have 10"\n- Beans: "I have 100kg, I reorder when I have 20kg"\n- Water: "I have 50 bottles, I reorder when I have 15"\n\nEnter YOUR minimum level:`,
        product.minStock || Math.ceil(product.quantity * 0.2)
    );
    
    const minStock = parseInt(logic) || product.minStock;
    
    const orderAmount = prompt(
        `When you have ${minStock}${product.unit}, how much do you buy?\n\nExample:\n- Small shop: "I buy 24 again (soda)"\n- Big shop: "I buy 100 again (soda)"\n- Farmer: "I buy 50kg again (beans)"\n\nEnter AMOUNT you buy at once:`,
        product.orderQuantity || product.quantity
    );
    
    const orderQuantity = parseInt(orderAmount) || product.orderQuantity;
    
    product.minStock = minStock;
    product.orderQuantity = orderQuantity;
    product.streetLogic = `${minStock}${product.unit} ‚Üí ${orderQuantity}${product.unit}`;
    
    saveData('bizbook_stock', stock);
    refreshStock();
    
    alert(`‚úÖ Set!\n\n${product.name}:\n‚Ä¢ Reorder when: ${minStock}${product.unit}\n‚Ä¢ Order amount: ${orderQuantity}${product.unit}\n\nSystem will remind you!`);
            }

            function refreshBuyList() {
    const buyList = document.getElementById('buy-list');
    let itemsToBuy = [];
    let totalCost = 0;
    
    stock.forEach(item => {
        if (item.quantity <= item.minStock) {
            const needed = item.orderQuantity || (item.minStock * 3 - item.quantity);
            const cost = needed * item.cost;
            
            itemsToBuy.push({
                id: item.id,
                name: item.name,
                needed: needed,
                unit: item.unit,
                current: item.quantity,
                minStock: item.minStock,
                cost: cost,
                streetLogic: item.streetLogic || `${item.minStock}${item.unit} ‚Üí ${needed}${item.unit}`
            });
            
            totalCost += cost;
        }
    });
    
    document.getElementById('total-cost').textContent = formatCurrency(totalCost);
    
    if (itemsToBuy.length === 0) {
        buyList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">Nothing to buy now</div>';
        return;
    }
    
    buyList.innerHTML = itemsToBuy.map(item => `
        <div class="item" onclick="showBuyOptions('${item.name}')">
            <div class="item-info">
                <div class="item-name">${item.name}</div>
                <div class="item-detail">
                    <strong>Now: ${item.current}${item.unit}</strong><br>
                    <small>${item.streetLogic}</small><br>
                    <small style="color: #e74c3c;">Need: ${item.needed}${item.unit}</small>
                </div>
            </div>
            <div class="item-amount">${formatCurrency(item.cost)}</div>
        </div>
    `).join('');
}

function showBuyOptions(productName) {
    const product = stock.find(p => p.name === productName);
    if (!product) return;
    
    const action = prompt(
        `${product.name}\nNeed to buy: ${product.orderQuantity || (product.minStock * 3 - product.quantity)}${product.unit || ''}\nCost: ${formatCurrency((product.orderQuantity || (product.minStock * 3 - product.quantity)) * product.cost)}\n\nChoose:\n1. Create WhatsApp order\n2. Change order amount\n3. Mark as bought\n\nEnter number (1-3):`,
        "1"
    );
    
    switch(action) {
        case "1": createSmartOrder(); break;
        case "2": 
            const newAmount = parseInt(prompt(`New order amount for ${product.name} (current: ${product.orderQuantity}${product.unit || ''}):`, product.orderQuantity));
            if (newAmount && newAmount > 0) {
                product.orderQuantity = newAmount;
                saveData('bizbook_stock', stock);
                refreshBuyList();
                alert(`‚úÖ Order amount updated: ${newAmount}${product.unit || ''}`);
            }
            break;
        case "3":
            product.quantity += (product.orderQuantity || (product.minStock * 3 - product.quantity));
            saveData('bizbook_stock', stock);
            refreshStock();
            refreshBuyList();
            alert(`‚úÖ ${product.orderQuantity || (product.minStock * 3 - product.quantity)}${product.unit || ''} of ${product.name} added to stock`);
            break;
    }
}

function createSmartOrder() {
    let itemsToBuy = [];
    let totalCost = 0;
    let supplierMessage = "";
    
    stock.forEach(item => {
        if (item.quantity <= item.minStock) {
            const needed = item.orderQuantity || (item.minStock * 3 - item.quantity);
            const cost = needed * item.cost;
            
            let orderText;
            if (item.unit === 'kg') {
                orderText = `${item.name}: ${needed}kg`;
            } else if (item.unit === 'liter') {
                orderText = `${item.name}: ${needed}liter`;
            } else {
                orderText = `${item.name}: ${needed}`;
            }
            
            itemsToBuy.push({
                name: item.name,
                needed: needed,
                unit: item.unit,
                cost: cost,
                orderText: orderText
            });
            
            totalCost += cost;
            supplierMessage += `‚Ä¢ ${orderText}\n`;
        }
    });
    
    if (itemsToBuy.length === 0) {
        alert('Nothing to buy now');
        return;
    }
    
    const supplier = prompt(
        `Buy from who?\n1. Bwana Juma\n2. Soda Business\n3. Other supplier\n\nEnter number or name:`,
        "Bwana Juma"
    );
    
    let supplierName = supplier;
    if (supplier === '1') supplierName = "Bwana Juma";
    if (supplier === '2') supplierName = "Soda Business";
    
    const message = `Habari ${supplierName},\n\nI need to buy:\n${supplierMessage}\nApprox total: ${formatCurrency(totalCost)}\n\nWhen can I pay you?`;
    
    const supplierPhone = prompt(
        `${supplierName}'s phone (can leave empty):`,
        "0712xxxxxx"
    );
    
    if (supplierPhone && supplierPhone.length >= 9) {
        window.open(`https://wa.me/${supplierPhone}?text=${encodeURIComponent(message)}`, '_blank');
    } else {
        navigator.clipboard.writeText(message);
        alert(`‚úÖ Order copied to clipboard!\n\nPaste in WhatsApp to ${supplierName}`);
    }
            }

function refreshSales() {
    const today = new Date().toDateString();
    const todaySales = sales.filter(sale => new Date(sale.date).toDateString() === today);
    const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
    
    document.getElementById('today-sales').textContent = formatCurrency(totalSales);
    document.getElementById('sales-count').textContent = todaySales.length;
    document.getElementById('cash-sales-total').textContent = formatCurrency(totalSales);
    
    const salesList = document.getElementById('sales-list');
    if (todaySales.length === 0) {
        salesList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">No sales today</div>';
        return;
    }
    
    salesList.innerHTML = todaySales.map(sale => `
        <div class="item" onclick="showSaleMenu(${sale.id})">
            <div class="item-info">
                <div class="item-name">${sale.customer}</div>
                <div class="item-detail">${sale.product} √ó ${sale.quantity}${sale.unit || ''} | ${sale.time}</div>
            </div>
            <div class="item-amount">${formatCurrency(sale.total)}</div>
        </div>
    `).join('');
    
    updateCashCalculation();
}

function refreshCash() {
    const todaySales = sales.filter(sale => 
        new Date(sale.date).toDateString() === new Date().toDateString()
    );
    const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
    
    document.getElementById('morning-cash').value = cash.morning || '';
    document.getElementById('expenses').value = cash.expenses || '';
    document.getElementById('cash-sales-total').textContent = formatCurrency(totalSales);
    
    updateCashCalculation();
}

function updateCashCalculation() {
    const morningCash = parseFloat(document.getElementById('morning-cash').value) || 0;
    const todaySales = sales.filter(sale => 
        new Date(sale.date).toDateString() === new Date().toDateString()
    );
    const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
    const expenses = parseFloat(document.getElementById('expenses').value) || 0;
    
    const expectedCash = morningCash + totalSales - expenses;
    document.getElementById('expected-cash').textContent = formatCurrency(expectedCash);
}

function saveCash() {
    const morningCash = parseFloat(document.getElementById('morning-cash').value) || 0;
    const expenses = parseFloat(document.getElementById('expenses').value) || 0;
    
    cash = {
        morning: morningCash,
        expenses: expenses,
        lastUpdated: new Date().toISOString()
    };
    
    saveData('bizbook_cash', cash);
    alert('‚úÖ Cash saved!');
}

function refreshDebts() {
    const debtList = document.getElementById('debt-list');
    
    if (debts.length === 0) {
        debtList.innerHTML = '<div style="color: #666; padding: 20px; text-align: center;">No debts</div>';
        return;
    }
    
    // Sort by most recent first
    debts.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    debtList.innerHTML = debts.map(debt => `
        <div class="item" onclick="showDebtMenu(${debt.id})">
            <div class="item-info">
                <div class="item-name">${debt.customer}</div>
                <div class="item-detail">
                    ${debt.date} ${debt.phone ? `| ${debt.phone}` : ''}
                    ${debt.note ? `<br><small>${debt.note}</small>` : ''}
                </div>
            </div>
            <div class="item-amount">${formatCurrency(debt.amount)}</div>
        </div>
    `).join('');
            }

function showDebtMenu(debtId) {
    const debt = debts.find(d => d.id === debtId);
    if (!debt) return;
    
    const options = `
1. üí¨ Send WhatsApp Reminder
2. ‚ûï Increase Debt Amount
3. ‚ûñ Decrease Debt Amount
4. ‚úÖ Mark as Paid (Remove)
5. üìù Add/Edit Note
6. ‚ùå Delete Debt
    `;
    
    const action = prompt(
        `${debt.customer}\nOwed: ${formatCurrency(debt.amount)}\nDate: ${debt.date}\n${debt.note ? `Note: ${debt.note}\n` : ''}\nChoose action:\n${options}`,
        "1"
    );
    
    switch(action) {
        case "1": sendDebtReminder(debtId); break;
        case "2": changeDebtAmount(debtId, 'increase'); break;
        case "3": changeDebtAmount(debtId, 'decrease'); break;
        case "4": markDebtAsPaid(debtId); break;
        case "5": addDebtNote(debtId); break;
        case "6": deleteDebt(debtId); break;
        default: break;
    }
            }

function sendDebtReminder(debtId) {
    const debt = debts.find(d => d.id === debtId);
    if (!debt) return;
    
    if (!debt.phone) {
        const phone = prompt(`WhatsApp number for ${debt.customer}:`, "2557xxxxxx");
        if (!phone) return;
        debt.phone = phone;
        saveData('bizbook_debts', debts);
    }
    
    const message = `Habari ${debt.customer},\n\nKumbukumbu ya deni:\n\nKiasi: ${formatCurrency(debt.amount)}\nTarehe: ${debt.date}\n${debt.note ? `Sababu: ${debt.note}\n` : ''}\nTafadhali lipa deni lako.\n\nAsante.`;
    
    if (debt.phone) {
        window.open(`https://wa.me/${debt.phone}?text=${encodeURIComponent(message)}`, '_blank');
        alert(`‚úÖ WhatsApp message ready for ${debt.customer}`);
    } else {
        navigator.clipboard.writeText(message);
        alert(`‚úÖ Message copied!\n\nPaste in WhatsApp to ${debt.customer}`);
    }
}

function changeDebtAmount(debtId, action) {
    const debt = debts.find(d => d.id === debtId);
    if (!debt) return;
    
    const currentAmount = debt.amount;
    const changeType = action === 'increase' ? 'Increase' : 'Decrease';
    
    const changeAmount = parseInt(prompt(
        `${debt.customer}\nCurrent debt: ${formatCurrency(currentAmount)}\n\n${changeType} amount (TZS):`,
        "1000"
    )) || 0;
    
    if (changeAmount <= 0) return;
    
    if (action === 'increase') {
        debt.amount += changeAmount;
        debt.date = new Date().toLocaleDateString('sw-TZ'); // Update date
        alert(`‚úÖ Debt increased by ${formatCurrency(changeAmount)}\nNew total: ${formatCurrency(debt.amount)}`);
    } else {
        if (changeAmount > debt.amount) {
            alert(`‚ùå Cannot decrease by more than debt amount!`);
            return;
        }
        debt.amount -= changeAmount;
        if (debt.amount === 0) {
            markDebtAsPaid(debtId);
            return;
        }
        alert(`‚úÖ Debt decreased by ${formatCurrency(changeAmount)}\nRemaining: ${formatCurrency(debt.amount)}`);
    }
    
    saveData('bizbook_debts', debts);
    refreshDebts();
}

function markDebtAsPaid(debtId) {
    const debt = debts.find(d => d.id === debtId);
    if (!debt) return;
    
    if (confirm(`‚úÖ Mark ${debt.customer}'s debt of ${formatCurrency(debt.amount)} as PAID?`)) {
        // Add to today's sales as "Debt Payment"
        const sale = {
            id: Date.now(),
            customer: `${debt.customer} (Debt Paid)`,
            product: "Debt Payment",
            quantity: 1,
            unit: "payment",
            total: debt.amount,
            date: new Date().toISOString(),
            time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
        };
        
        sales.push(sale);
        saveData('bizbook_sales', sales);
        
        // Remove from debts
        const index = debts.findIndex(d => d.id === debtId);
        if (index !== -1) {
            debts.splice(index, 1);
            saveData('bizbook_debts', debts);
        }
        
        refreshDebts();
        refreshSales();
        updateCashCalculation();
        
        alert(`‚úÖ ${debt.customer}'s debt marked as PAID\nAdded to today's sales`);
    }
}

function addDebtNote(debtId) {
    const debt = debts.find(d => d.id === debtId);
    if (!debt) return;
    
    const note = prompt(`Add note for ${debt.customer}'s debt (e.g., "For soda", "Will pay Friday"):`, debt.note || "");
    
    if (note !== null) {
        debt.note = note;
        saveData('bizbook_debts', debts);
        refreshDebts();
        alert(`‚úÖ Note added for ${debt.customer}`);
    }
}

function deleteDebt(debtId) {
    const debt = debts.find(d => d.id === debtId);
    if (!debt) return;
    
    if (confirm(`‚ùå Permanently delete ${debt.customer}'s debt of ${formatCurrency(debt.amount)}?\n\nThis will NOT add to sales.`)) {
        const index = debts.findIndex(d => d.id === debtId);
        if (index !== -1) {
            debts.splice(index, 1);
            saveData('bizbook_debts', debts);
            refreshDebts();
            alert(`‚úÖ ${debt.customer}'s debt deleted`);
        }
    }
            }

function addDebtUSSD() {
    const customer = prompt("Customer name:", "Customer");
    if (!customer) return;
    
    const amount = parseInt(prompt(`Debt amount (TZS):`, "5000")) || 0;
    const phone = prompt("Customer phone (optional):", "") || "";
    const note = prompt("Reason/Note (optional):", "") || "";
    
    if (!customer || amount <= 0) {
        alert("Enter customer name and debt amount");
        return;
    }
    
    const newDebt = {
        id: Date.now(),
        customer: customer,
        amount: amount,
        phone: phone,
        note: note,
        date: new Date().toLocaleDateString('sw-TZ')
    };
    
    debts.push(newDebt);
    saveData('bizbook_debts', debts);
    refreshDebts();
    
    // Always ask if they want to send WhatsApp reminder
    if (phone && confirm(`Send WhatsApp reminder to ${customer}?`)) {
        const message = `Habari ${customer},\n\nUmekopa: ${formatCurrency(amount)}\nTarehe: ${newDebt.date}\n${note ? `Sababu: ${note}\n` : ''}\nTafadhali kumbuka kulipa.`;
        window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
    }
    
    alert(`‚úÖ ${formatCurrency(amount)} debt added for ${customer}`);
            }

function quickSale() {
    if (stock.length === 0) {
        alert('First add products in "Products" tab');
        return;
    }
    
    const customer = prompt('Customer name:', 'Customer');
    const productNames = stock.map(item => item.name).join(', ');
    const productName = prompt(`Which product? (${productNames}):`);
    
    const product = stock.find(item => item.name.toLowerCase() === productName?.toLowerCase());
    if (!product) {
        alert('Product not found');
        return;
    }
    
    const quantity = parseFloat(prompt(`Quantity of ${product.name} in ${product.unit}:`, product.unit === 'pcs' ? "1" : "0.5")) || 0;
    
    if (quantity > product.quantity) {
        alert(`Only ${product.quantity}${product.unit} of ${product.name} available`);
        return;
    }
    
    const total = quantity * product.price;
    
    const newSale = {
        id: Date.now(),
        customer: customer,
        product: product.name,
        quantity: quantity,
        unit: product.unit,
        total: total,
        date: new Date().toISOString(),
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
    };
    
    sales.push(newSale);
    saveData('bizbook_sales', sales);
    
    product.quantity -= quantity;
    saveData('bizbook_stock', stock);
    
    refreshSales();
    refreshStock();
    refreshBuyList();
    updateCashCalculation();
    
    alert(`‚úÖ ${customer}: ${product.name} √ó ${quantity}${product.unit} = ${formatCurrency(total)}`);
}

function quickExpense() {
    const amount = parseFloat(prompt('Expense amount (TZS):', '')) || 0;
    const reason = prompt('Reason:', '') || 'Expense';
    
    if (amount <= 0) {
        alert('Enter amount');
        return;
    }
    
    const currentExpenses = cash.expenses || 0;
    cash.expenses = currentExpenses + amount;
    saveData('bizbook_cash', cash);
    
    document.getElementById('expenses').value = cash.expenses;
    updateCashCalculation();
    
    alert(`‚úÖ ${reason}: ${formatCurrency(amount)} added`);
}

function exportData() {
    const exportType = prompt(
        "üì§ Export as:\n\n" +
        "1. üìÑ SIMPLE RECEIPT (for today only)\n" +
        "2. üìã DAILY REPORT (sales + cash summary)\n" +
        "3. üìä STOCK REPORT (what to buy)\n" +
        "4. üìà BUSINESS REPORT (all data for accountant)\n\n" +
        "Enter number (1-4):",
        "1"
    );
    
    switch(exportType) {
        case "1": exportSimpleReceipt(); break;
        case "2": exportDailyReport(); break;
        case "3": exportStockReport(); break;
        case "4": exportBusinessReport(); break;
        default: exportSimpleReceipt(); break;
    }
}

// 1. SIMPLE RECEIPT - For giving to customers or quick reference
function exportSimpleReceipt() {
    const today = new Date().toLocaleDateString('sw-TZ');
    const todaySales = sales.filter(sale => 
        new Date(sale.date).toDateString() === new Date().toDateString()
    );
    
    let receipt = `‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n`;
    receipt += `‚ïë      üìì BIZBOOK RECEIPT       ‚ïë\n`;
    receipt += `‚ïë      ${today}       ‚ïë\n`;
    receipt += `‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n`;
    receipt += `‚ïë                              ‚ïë\n`;
    
    if (todaySales.length === 0) {
        receipt += `‚ïë   Hakuna mauzo leo           ‚ïë\n`;
    } else {
        let total = 0;
        todaySales.forEach(sale => {
            receipt += `‚ïë ${sale.product} √ó ${sale.quantity}${sale.unit}\n`;
            receipt += `‚ïë   ${sale.customer}: ${formatCurrency(sale.total)}\n`;
            total += sale.total;
        });
        receipt += `‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\n`;
        receipt += `‚ïë JUMLA: ${formatCurrency(total).padStart(20)} ‚ïë\n`;
    }
    
    receipt += `‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n`;
    receipt += `\nüìû Call: _________________\nüí¨ Note: _________________\n`;
    
    // Copy to clipboard AND show on screen
    navigator.clipboard.writeText(receipt);
    alert(`‚úÖ Receipt copied!\n\n${receipt}`);
}

function exportDailyReport() {
    const today = new Date().toLocaleDateString('sw-TZ');
    const todaySales = sales.filter(sale => 
        new Date(sale.date).toDateString() === new Date().toDateString()
    );
    const totalSales = todaySales.reduce((sum, sale) => sum + sale.total, 0);
    
    let report = `=== BIZBOOK DAILY REPORT ===\n`;
    report += `Date: ${today}\n`;
    report += `‚ïê`.repeat(35) + `\n\n`;
    
    report += `üì¶ MORNING CASH: ${formatCurrency(cash.morning || 0)}\n`;
    report += `üí∞ TODAY'S SALES:\n`;
    report += `‚îÄ`.repeat(35) + `\n`;
    
    if (todaySales.length === 0) {
        report += `No sales today\n`;
    } else {
        todaySales.forEach(sale => {
            report += `‚Ä¢ ${sale.time} - ${sale.customer}\n`;
            report += `  ${sale.product} √ó ${sale.quantity}${sale.unit}\n`;
            report += `  ${formatCurrency(sale.total)}\n\n`;
        });
    }
    
    report += `‚ïê`.repeat(35) + `\n`;
    report += `TOTAL SALES: ${formatCurrency(totalSales)}\n`;
    report += `EXPENSES: ${formatCurrency(cash.expenses || 0)}\n`;
    report += `‚îÄ`.repeat(35) + `\n`;
    report += `EXPECTED CASH: ${formatCurrency((cash.morning || 0) + totalSales - (cash.expenses || 0))}\n`;
    report += `‚ïê`.repeat(35) + `\n`;
    
    // WhatsApp-friendly format
    const whatsappReport = `*BIZBOOK REPORT - ${today}*\n\n` +
                          `Morning Cash: ${formatCurrency(cash.morning || 0)}\n` +
                          `Total Sales: ${formatCurrency(totalSales)}\n` +
                          `Expenses: ${formatCurrency(cash.expenses || 0)}\n` +
                          `Expected Cash: ${formatCurrency((cash.morning || 0) + totalSales - (cash.expenses || 0))}\n\n` +
                          `Customers: ${todaySales.length}`;
    
    const sendToWhatsapp = confirm(`‚úÖ Daily report ready!\n\nSend to WhatsApp?`);
    
    if (sendToWhatsapp) {
        const phone = prompt("Send to which number?", "2557xxxxxx");
        if (phone) {
            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(whatsappReport)}`, '_blank');
        }
    } else {
        navigator.clipboard.writeText(report);
        alert(`‚úÖ Daily report copied to clipboard!\n\n${report}`);
    }
}

function exportStockReport() {
    let report = `=== BIZBOOK STOCK REPORT ===\n`;
    report += `Date: ${new Date().toLocaleDateString('sw-TZ')}\n`;
    report += `‚ïê`.repeat(35) + `\n\n`;
    
    let needsReorder = [];
    let totalCost = 0;
    
    stock.forEach(item => {
        if (item.quantity <= item.minStock) {
            const needed = item.orderQuantity || (item.minStock * 3 - item.quantity);
            const cost = needed * item.cost;
            
            report += `‚ö†Ô∏è ${item.name}\n`;
            report += `   Now: ${item.quantity}${item.unit}\n`;
            report += `   Need: ${needed}${item.unit}\n`;
            report += `   Cost: ${formatCurrency(cost)}\n\n`;
            
            needsReorder.push({
                name: item.name,
                needed: needed,
                unit: item.unit,
                cost: cost
            });
            
            totalCost += cost;
        }
    });
    
    if (needsReorder.length === 0) {
        report += `All stock OK üëç\n`;
    } else {
        report += `‚ïê`.repeat(35) + `\n`;
        report += `TOTAL NEEDED: ${formatCurrency(totalCost)}\n`;
        report += `ITEMS: ${needsReorder.length}\n`;
    }
    
    // Create WhatsApp order message
    if (needsReorder.length > 0) {
        let orderMessage = `*ORDER LIST*\nDate: ${new Date().toLocaleDateString('sw-TZ')}\n\n`;
        
        needsReorder.forEach(item => {
            orderMessage += `‚Ä¢ ${item.name}: ${item.needed}${item.unit}\n`;
        });
        
        orderMessage += `\nApprox Total: ${formatCurrency(totalCost)}`;
        
        const makeOrder = confirm(`${needsReorder.length} items need reorder.\n\nCreate WhatsApp order?`);
        
        if (makeOrder) {
            const supplier = prompt("Supplier name:", "Bwana Juma");
            const phone = prompt("Supplier WhatsApp:", "2557xxxxxx");
            
            if (phone) {
                const finalMessage = `Habari ${supplier},\n\n${orderMessage}\n\nTunaweza lipa lini?`;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(finalMessage)}`, '_blank');
            }
        }
    }
    
    navigator.clipboard.writeText(report);
    alert(`‚úÖ Stock report copied!\n\n${report}`);
}

function exportBusinessReport() {
    const allData = {
        "business_name": "BizBook Business",
        "report_date": new Date().toLocaleString('sw-TZ'),
        "cash_summary": {
            "morning_cash": cash.morning || 0,
            "total_expenses": cash.expenses || 0,
            "current_cash": (cash.morning || 0) + 
                           sales.filter(s => new Date(s.date).toDateString() === new Date().toDateString())
                                .reduce((sum, s) => sum + s.total, 0) - 
                           (cash.expenses || 0)
        },
        "today_sales": sales.filter(s => new Date(s.date).toDateString() === new Date().toDateString())
                           .map(s => ({
                               time: s.time,
                               customer: s.customer,
                               product: s.product,
                               quantity: `${s.quantity}${s.unit}`,
                               amount: s.total
                           })),
        "stock_status": stock.map(s => ({
            product: s.name,
            current: `${s.quantity}${s.unit}`,
            min_level: `${s.minStock}${s.unit}`,
            status: s.quantity <= s.minStock ? "NEED BUY" : "OK"
        })),
        "total_debts": debts.reduce((sum, d) => sum + d.amount, 0)
    };
    
    const readableReport = JSON.stringify(allData, null, 2)
        .replace(/"/g, '')
        .replace(/{/g, '')
        .replace(/}/g, '')
        .replace(/\[/g, '')
        .replace(/\]/g, '')
        .replace(/,/g, '\n');
    
    const dataStr = JSON.stringify(allData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `bizbook-report-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`‚úÖ Business report saved as JSON\n\nAlso copied readable version to clipboard!`);
    navigator.clipboard.writeText(readableReport);
    }

function formatCurrency(amount) {
    return new Intl.NumberFormat('sw-TZ', {
        style: 'currency',
        currency: 'TZS',
        minimumFractionDigits: 0
    }).format(amount);
}

function showMenu() {
    const menu = `
‚öôÔ∏è CHAGUA HUDUMA:

[1] üìñ MAAGIZO - Jinsi ya kutumia BizBook
[2] üíæ BACKUP - Pakua data yako yote
[3] üóëÔ∏è FUTA - Ondoa data ya mfano pekee
[4] ‚ÑπÔ∏è KUHUSU - Habari za BizBook

Weka namba (1-4):`;
    
    const choice = prompt(menu, "1");
    
    if (choice === "1") showHelp();
    else if (choice === "2") exportData();
    else if (choice === "3") resetDemoData();
    else if (choice === "4") showAbout();
    else alert("‚ö†Ô∏è Chagua namba 1, 2, 3 au 4 tu");
            }

function showHelp() {
    const helpText = `
‚ùì MASWALI YA MARA KWA MARA:

üì± JINSI YA KUIPAKUA BIZBOOK:
1. Fungua Chrome browser
2. Andika anuani: https://feistyfeller208-stack.github.io/BizBook/
3. Bonyeza "‚ãÆ" (dots tatu) juu kulia
4. Chagua "Add to Home Screen"
5. Bonyeza "install"
6. App itaonekana kwenye home screen yako!

üõí KUANZA BIASHARA:
1. Bonyeza "Add Product" kwanza
2. Weka bidhaa ZAKO (jina, bei, wingi)
3. Anza mauzo kwa "Quick Sale"

üí∞ DENI NA PESA:
‚Ä¢ Deni: Andika, bonyeza jina, tuma WhatsApp
‚Ä¢ Pesa: Weka pesa asubuhi, ona jioni

üíæ DATA YAKO:
‚Ä¢ Yote inahifadhiwa kwenye SIMU yako
‚Ä¢ Hakuna internet inahitajika
‚Ä¢ Toa backup kwa "Export"

üìû USHAURI ZAIDI:
‚Ä¢ WhatsApp: +255759968552
‚Ä¢ Tuma screen shot kama shida`;
    
    alert(helpText);
            }

function resetDemoData() {
    if (confirm("‚ùå Futa data yote ya mfano?\n\nHii itafuta bidhaa, mauzo, deni, na pesa.\n\nTUMAHALIKI: Data yako halisi itabaki!")) {
        // Keep only real user data (not demo data)
        const realData = {
            stock: [],
            sales: [],
            debts: [],
            cash: { morning: 0, expenses: 0 }
        };
        
        // You might want to backup first
        exportData();
        
        // Clear everything
        localStorage.clear();
        
        // Reload page
        alert("‚úÖ Data ya mfano imefutwa!\n\nApp itaanzisha upya...");
        location.reload();
    }
}

function showAbout() {
    alert(`üíº BIZBOOK v3.0\n\nApp ya kuendesha biashara yako\n‚Ä¢ Bure kabisa\n‚Ä¢ Offline\n‚Ä¢ Inahifadhi kwenye simu\n\nüë®‚Äçüíª Developed by: Guy Fei\n\nüìû Support: +255759968552`);
            }

refreshStock();
refreshSales();
refreshCash();
refreshDebts();
refreshBuyList();

document.getElementById('morning-cash').addEventListener('input', updateCashCalculation);
document.getElementById('expenses').addEventListener('input', updateCashCalculation);

console.log('üì± BizBook loaded!');
</script>
    <script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./service-worker.js");
}
    </script>
</body>
</html>
